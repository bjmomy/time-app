<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ÏãúÍ∞Ñ Í¥ÄÎ¶¨ Ïï± v9.0</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ko.js"></script>

    <style>
        html, body {
            height: 100vh; height: 100dvh; margin: 0; padding: 0; overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #f4f4f9; font-size: 14px;
        }
        .app-container { display: flex; flex-direction: column; height: 100%; width: 100%; }
        .hidden { display: none !important; }

        /* --- Ìó§Îçî --- */
        #date-header {
            flex-shrink: 0; padding: 10px; background-color: #ffffff;
            border-bottom: 1px solid #e0e0e0; display: flex;
            justify-content: space-between; align-items: center;
        }
        #date-controls-left, #center-controls, #search-controls-right {
            display: flex;
            align-items: center;
        }
        #date-header button {
            background: none; border: none; font-size: 20px; font-weight: bold;
            color: #007aff; cursor: pointer; padding: 0 10px;
        }
        #current-date {
            min-width: 120px; text-align: center; font-size: 18px;
            font-weight: 600; color: #333;
        }
        #calendar-btn, #memo-btn, #today-btn { 
            font-size: 24px; padding: 0 5px; 
        }
        #center-controls button { font-size: 24px; padding: 0 8px; }
        #search-controls-right { justify-content: flex-end; }
        #playground-btn, #settings-btn { font-size: 24px; padding: 0 8px; }
        #search-input {
            border: 1px solid #ccc; border-radius: 4px; padding: 6px 8px;
            font-size: 14px; max-width: 100px;
        }
        #search-btn { font-size: 22px; padding: 0 8px; }

        /* --- Í≥µÌÜµ Ìå®ÎÑê Ïª®ÌÖåÏù¥ÎÑà --- */
        .main-container {
            display: flex; flex-grow: 1; width: 100%;
            background-color: #ffffff; overflow: hidden; min-height: 0;
        }
        .left-panel, .right-panel {
            flex: 1; padding: 10px; display: flex;
            flex-direction: column; min-width: 0;
        }
        .left-panel { border-right: 1px solid #e0e0e0; }
        .single-panel-view {
            padding: 10px; display: flex; flex-direction: column;
            flex-grow: 1; min-width: 100%; box-sizing: border-box;
        }

        h3 {
            margin-top: 0; margin-bottom: 8px; color: #333;
            padding-bottom: 4px;
            font-size: 16px; font-weight: 600; flex-shrink: 0;
        }
        .h3-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #eee;
            padding-bottom: 4px;
            margin-bottom: 8px;
        }
        .h3-wrapper h3 {
            margin-bottom: 0;
            border-bottom: none;
            padding-bottom: 0;
        }
        #apply-routine-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #007aff;
            padding: 0;
        }
        #apply-routine-btn.active {
            color: #FF9500;
        }
        #apply-routine-btn:hover { opacity: 0.7; }

        /* --- Î©îÎ™® Ïª®ÌÖåÏù¥ÎÑà --- */
        #memo-textarea {
            width: 100%; height: 100%; border: 1px solid #e0e0e0;
            border-radius: 4px; padding: 10px; font-size: 15px;
            font-family: inherit; box-sizing: border-box; resize: none;
        }

        /* --- Í≥ÑÌöçÌëú: Ìï† Ïùº ÏÑπÏÖò --- */
        #todo-section { flex: 1; display: flex; flex-direction: column; min-height: 0; }
        .input-section { display: flex; margin-bottom: 10px; flex-shrink: 0; gap: 5px; } /* gap Ï∂îÍ∞Ä */
        .input-section input[type="text"],
        .input-section input[type="number"] {
            flex-grow: 1; border: 1px solid #ccc; border-radius: 4px;
            padding: 8px 10px; font-size: 14px;
        }
        .input-section button {
            background-color: #007aff; color: white; border: none; border-radius: 4px;
            padding: 8px 12px; cursor: pointer;
            font-size: 16px; font-weight: bold;
            flex-shrink: 0;
        }
        #todo-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex-grow: 1; }
        .task-item {
            padding: 8px 10px;
            border: none;
            border-bottom: 1px solid #f0f0f0;
            border-radius: 0;
            margin-bottom: 5px;
            font-size: 14px;
            display: flex;
            align-items: center;
            transition: opacity 0.3s;
        }
        .routine-item {
            background-color: #fdfdfd;
        }
        .routine-item span::before {
            content: "üìå ";
            font-size: 12px;
            opacity: 0.6;
        }
        
        /* ÏàòÏ†ï Í∞ÄÎä•ÌïòÎèÑÎ°ù outline Ï†úÍ±∞ */
        .task-item span { flex-grow: 1; cursor: pointer; margin-right: 5px; outline: none; }
        input[type="checkbox"] { margin-right: 8px; flex-shrink: 0; accent-color: #007aff; }
        .task-item.completed { opacity: 0.5; }
        .task-item.completed span { text-decoration: line-through; color: #888; }
        .task-item.is-important span { color: #d32f2f; font-weight: bold; }
        .task-item.selected { background-color: transparent; }
        .delete-btn {
            background: none; border: none; color: #ff3b30; font-size: 22px;
            font-weight: 500; line-height: 1; cursor: pointer;
            padding: 0 2px 0 8px; margin-left: auto; flex-shrink: 0;
        }

        /* Í≥ÑÌöçÌëú: 'Ï§ëÏöîÌïú 5Í∞ÄÏßÄ' */
        #important-section {
            margin-top: 10px; padding-top: 10px; border-top: 1px dashed #ccc;
            flex-shrink: 0; overflow-y: auto; max-height: 200px;
        }
        #important-list { min-height: 40px; }
        .draggable-task {
            padding: 10px;
            background-color: transparent;
            border: none;
            border-bottom: 1px solid #f0f0f0;
            color: #d32f2f;
            border-radius: 0;
            margin-bottom: 5px;
            cursor: grab;
            font-weight: bold;
            font-size: 15px;
            text-align: center;
        }

        /* --- Í≥ÑÌöçÌëú: ÌÉÄÏûÑÎùºÏù∏ --- */
        #timeline-wrapper { flex-grow: 1; overflow-y: auto; }
        #timeline { position: relative; }
        .time-slot {
            min-height: 45px;
            height: auto;
            border-bottom: 1px solid #e0e0e0;
            position: relative;
            padding-left: 40px; 
            box-sizing: border-box;
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            align-items: flex-start;
            padding-top: 18px;
            padding-bottom: 4px;
        }
        .time-label {
            position: absolute;
            left: 3px;
            top: 5px;
            font-size: 11px;
            color: #888;
            font-weight: bold;
        }
        .time-slot.drag-over { background-color: #e0f7fa; }
        
        .dropped-task {
            display: inline-flex;
            align-items: center;
            padding: 2px 5px;
            font-size: 12px;
            margin-top: 2px;
            margin-right: 4px;
            font-weight: 500;
            cursor: grab;
            background-color: #E3F2FD;
            border: 1px solid #BBDEFB;
            border-radius: 4px;
            line-height: 1.2;
        }
        .dropped-task:active { cursor: grabbing; }
        .dropped-task.is-important { 
            color: #d32f2f;
            background-color: #FFEBEE;
            border-color: #FFCDD2;
        }
        .dropped-task.is-general { 
            color: #333;
            background-color: #E3F2FD;
            border-color: #BBDEFB;
        }
        
        .timeline-delete-btn {
            background: none;
            border: none;
            color: #aaa;
            font-size: 16px;
            font-weight: bold;
            line-height: 1;
            cursor: pointer;
            padding: 0 0 0 5px;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
        }
        .dropped-task:hover .timeline-delete-btn {
            opacity: 1;
            pointer-events: auto;
        }
        .timeline-delete-btn:hover {
            color: #ff3b30;
        }


        /* --- ÎÜÄÏù¥ÌÑ∞(Playground) Ïä§ÌÉÄÏùº --- */
        #goal-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex-grow: 1; }
        .goal-item {
            padding: 10px; border: 1px solid #eee; border-radius: 4px;
            margin-bottom: 5px; font-size: 15px; display: flex;
            align-items: center; cursor: pointer;
        }
        .goal-item:hover { background-color: #f9f9f9; }
        .goal-item.selected { background-color: #eef8ff; border-color: #007aff; }
        .goal-item span { flex-grow: 1; outline: none; }
        .goal-item.completed span { text-decoration: line-through; color: #888; opacity: 0.7; }
        #goal-progress-view { display: flex; flex-direction: column; flex-grow: 1; min-height: 0; }
        #goal-progress-placeholder {
            flex-grow: 1; display: flex; align-items: center;
            justify-content: center; color: #aaa; font-size: 16px;
        }
        #goal-progress-content { display: flex; flex-direction: column; flex-grow: 1; min-height: 0; }
        #goal-progress-notes {
            width: 100%; height: 150px; border: 1px solid #e0e0e0;
            border-radius: 4px; padding: 10px; font-size: 15px;
            font-family: inherit; box-sizing: border-box; resize: vertical;
            margin-bottom: 10px; flex-shrink: 0;
        }
        #goal-progress-notes:focus { border-color: #007aff; box-shadow: 0 0 0 2px rgba(0,122,255,0.2); }
        #goal-image-controls {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 10px; flex-shrink: 0;
        }
        #goal-image-controls label {
            background-color: #007aff; color: white; padding: 8px 12px;
            border-radius: 4px; cursor: pointer; font-size: 14px;
        }
        #goal-image-controls input[type="file"] { display: none; }
        #export-goal-pdf-btn {
            background-color: #34c759; color: white; border: none;
            padding: 8px 12px; border-radius: 4px; font-size: 14px;
            font-weight: 600; cursor: pointer;
        }
        #goal-progress-images {
            flex-grow: 1; overflow-y: auto; border: 1px solid #eee;
            border-radius: 4px; padding: 5px; background: #fdfdfd;
        }
        .image-wrapper { position: relative; margin-bottom: 5px; line-height: 0; }
        .image-wrapper img {
            width: 100%; border-radius: 4px; cursor: pointer; transition: width 0.2s;
        }
        .image-wrapper img[data-size="100"] { width: 100%; }
        .image-wrapper img[data-size="75"] { width: 75%; }
        .image-wrapper img[data-size="50"] { width: 50%; }
        .image-controls {
            position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.5);
            border-radius: 4px; display: flex; opacity: 0; transition: opacity 0.2s;
        }
        .image-wrapper:hover .image-controls { opacity: 1; }
        .image-controls button {
            background: none; border: none; color: white; font-size: 18px;
            font-weight: bold; cursor: pointer; padding: 4px 8px;
        }
        .image-controls button:disabled { color: #888; cursor: not-allowed; }
        .image-controls button:hover:not(:disabled) { background: rgba(255,255,255,0.2); }
        .pdf-render-div {
            width: 100%; font-size: 15px; font-family: inherit; padding: 10px;
            box-sizing: border-box; background: white; white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* --- Î™∏Î¨¥Í≤å Í∏∞Î°ù --- */
        #weight-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex-grow: 1; }
        .weight-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 10px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 15px;
        }
        #import-weight-label {
            display: inline-block;
            background-color: #8e8e93;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            text-align: center;
            width: 100%;
            box-sizing: border-box;
        }
        #import-weight-label:hover { opacity: 0.8; }
        /* ÏùåÏ£ºÎüâ Ïä§ÌÉÄÏùº */
        .weight-alcohol {
            font-size: 13px;
            color: #ff3b30;
            margin-left: 10px;
            font-weight: bold;
        }

        /* --- Í∑∏ÎûòÌîÑ --- */
        #graph-chart-wrapper {
            flex-grow: 1; position: relative; min-height: 0;
        }
        #weight-chart { max-width: 100%; }

        /* --- Îã¨Î†• --- */
        .flatpickr-day.day-has-data::after {
            content: "‚Ä¢"; color: #f59e0b; position: absolute;
            bottom: -2px; left: 50%; transform: translateX(-50%); font-size: 16px;
        }

        /* --- Í≥µÌÜµ Î™®Îã¨ Ïä§ÌÉÄÏùº --- */
        .modal-overlay {
            position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; background-color: rgba(0,0,0,0.4);
            display: flex; justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: #fefefe; border-radius: 8px; padding: 20px;
            border: 1px solid #888; width: 90%; max-width: 500px;
            max-height: 80vh; display: flex; flex-direction: column;
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #eee; padding-bottom: 10px;
        }
        .modal-header h4 { margin: 0; font-size: 18px; }
        .modal-close-btn {
            font-size: 28px; font-weight: bold; color: #aaa;
            cursor: pointer; background: none; border: none; padding: 0;
        }
        
        /* --- Í≤ÄÏÉâ Î™®Îã¨ --- */
        #search-results-list { list-style: none; padding: 0; margin: 10px 0 0; overflow-y: auto; }
        .search-result-item {
            padding: 10px; border-bottom: 1px solid #f0f0f0; cursor: pointer;
        }
        .search-result-item:hover { background-color: #f4f4f9; }
        .search-result-item small { font-weight: 600; color: #007aff; display: block; }
        .search-result-item p { margin: 5px 0 0; color: #333; }
        
        /* --- ÏÑ§Ï†ï/Î£®Ìã¥ Î™®Îã¨ Ïä§ÌÉÄÏùº --- */
        .modal-body {
            padding-top: 15px;
            overflow-y: auto;
        }
        .modal-body label {
            display: block;
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 8px;
            color: #333;
        }
        .modal-body textarea {
            width: 100%;
            height: 150px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 8px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            margin-bottom: 15px;
        }
        .modal-body button {
            background-color: #007aff;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 15px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
            box-sizing: border-box;
        }
        .modal-body button.secondary {
            background-color: #f0f0f0;
            color: #333;
        }
        .modal-body button.danger {
            background-color: #ff3b30;
        }
        .modal-body button:hover {
            opacity: 0.8;
        }
        #import-data-label {
            display: inline-block;
            background-color: #5856d6;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            text-align: center;
            margin-top: 10px;
            width: 100%;
            box-sizing: border-box;
        }
        #import-data-label:hover { opacity: 0.8; }
        
    </style>
</head>
<body>

    <div class="app-container">
        
        <div id="date-header">
            <div id="date-controls-left">
                <button id="prev-day" aria-label="Ïù¥Ï†Ñ ÎÇ†Ïßú">-</button>
                <span id="current-date"></span>
                <button id="next-day" aria-label="Îã§Ïùå ÎÇ†Ïßú">+</button>
                <button id="today-btn" aria-label="Ïò§ÎäòÎ°ú Ïù¥Îèô">üéØ</button>
                <button id="calendar-btn" aria-label="Îã¨Î†• Ïó¥Í∏∞">üìÖ</button>
                <button id="memo-btn" aria-label="Î©îÎ™® Î≥¥Í∏∞">üìù</button>
            </div>
            <div id="center-controls">
                <button id="weight-btn" aria-label="Î™∏Î¨¥Í≤å">‚öñÔ∏è</button>
                <button id="graph-btn" aria-label="Í∑∏ÎûòÌîÑ">üìà</button>
            </div>
            <div id="search-controls-right">
                <button id="playground-btn" aria-label="ÎÜÄÏù¥ÌÑ∞">üèüÔ∏è</button>
                <input type="search" id="search-input" placeholder="Í≤ÄÏÉâ...">
                <button id="search-btn" aria-label="Í≤ÄÏÉâ">üîç</button>
                <button id="settings-btn" aria-label="ÏÑ§Ï†ï">‚öôÔ∏è</button>
            </div>
        </div>

        <div id="plan-container" class="main-container">
            <div class="left-panel">
                <div id="todo-section">
                    <div class="h3-wrapper">
                        <h3>Î®∏Î¶øÏÜç Ìï† Ïùº</h3>
                        <button id="apply-routine-btn" aria-label="Îß§Ïùº Î£®Ìã¥ Ï†ÅÏö©">üîÑ</button>
                    </div>
                    <div id="todo-input-section" class="input-section">
                        <input type="text" id="new-task-input" placeholder="ÏÉàÎ°úÏö¥ Ìï† Ïùº ÏûÖÎ†•...">
                        <button id="add-task-btn">+</button>
                    </div>
                    <ul id="todo-list"></ul>
                </div>
                <div id="important-section">
                    <h3>Ï§ëÏöîÌïú 5Í∞ÄÏßÄ</h3>
                    <div id="important-list"></div>
                </div>
            </div>
            <div class="right-panel">
                <h3>ÏãúÍ∞ÑÌëú</h3>
                <div id="timeline-wrapper">
                    <div id="timeline"></div>
                </div>
            </div>
        </div>
        
        <div id="memo-container" class="main-container single-panel-view hidden">
            <textarea id="memo-textarea" placeholder="Ïù¥ ÎÇ†Ïùò Î©îÎ™®Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."></textarea>
        </div>
        
        <div id="playground-container" class="main-container hidden">
            <div class="left-panel">
                <h3>Ïû•Í∏∞ Î™©Ìëú Î¶¨Ïä§Ìä∏</h3>
                <div id="goal-input-section" class="input-section">
                    <input type="text" id="new-goal-input" placeholder="ÏÉàÎ°úÏö¥ Î™©Ìëú ÏûÖÎ†•...">
                    <button id="add-goal-btn">+</button>
                </div>
                <ul id="goal-list"></ul>
            </div>
            <div class="right-panel">
                <h3>ÏßÑÏ≤ô ÏÉÅÌô©</h3>
                <div id="goal-progress-view">
                    <div id="goal-progress-placeholder">
                        ÏôºÏ™ΩÏóêÏÑú Î™©ÌëúÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.
                    </div>
                    <div id="goal-progress-content" class="hidden">
                        <textarea id="goal-progress-notes" placeholder="ÏßÑÏ≤ô ÏÉÅÌô©, ÏÉùÍ∞Å Îì±ÏùÑ Í∏∞Î°ùÌïòÏÑ∏Ïöî. Ïù¥ÎØ∏ÏßÄ Î∂ôÏó¨ÎÑ£Í∏∞ (Ctrl+V) Í∞ÄÎä•"></textarea>
                        <div id="goal-image-controls">
                            <label for="goal-image-upload">Ïù¥ÎØ∏ÏßÄ Ï∂îÍ∞Ä</label>
                            <input type="file" id="goal-image-upload" accept="image/*">
                            <button id="export-goal-pdf-btn">PDFÎ°ú ÎÇ¥Î≥¥ÎÇ¥Í∏∞</button>
                        </div>
                        <div id="goal-progress-images">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="weight-container" class="main-container single-panel-view hidden">
            <h3>Î™∏Î¨¥Í≤å Í∏∞Î°ù</h3>
            <div class="input-section">
                <input type="number" id="new-weight-input" placeholder="Ïò§Îäò Î™∏Î¨¥Í≤å (kg)" step="0.1">
                <input type="text" id="new-alcohol-input" placeholder="ÏùåÏ£ºÎüâ" style="flex-grow:0.5;">
                <button id="add-weight-btn">+</button>
            </div>
            <div class="input-section" style="margin-top: 5px;">
                <label for="import-weight-file" id="import-weight-label">Í≥ºÍ±∞ Í∏∞Î°ù (txt) Î∂àÎü¨Ïò§Í∏∞</label>
                <input type="file" id="import-weight-file" accept=".txt" style="display: none;">
            </div>
            <ul id="weight-list">
            </ul>
        </div>
        
        <div id="graph-container" class="main-container single-panel-view hidden">
            <h3 style="text-align: center;">Î™∏Î¨¥Í≤å Í∑∏ÎûòÌîÑ (<span id="graph-range-label">1Í∞úÏõî</span>)</h3>
            <div id="graph-chart-wrapper">
                <canvas id="weight-chart"></canvas>
            </div>
        </div>

    </div>

    <div id="search-results-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h4>Í≤ÄÏÉâ Í≤∞Í≥º</h4>
                <span id="close-search-modal" class="modal-close-btn" aria-label="Îã´Í∏∞">&times;</span>
            </div>
            <ul id="search-results-list"></ul>
        </div>
    </div>
    
    <div id="settings-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h4>ÏÑ§Ï†ï</h4>
                <button id="close-settings-modal" class="modal-close-btn" aria-label="Îã´Í∏∞">&times;</button>
            </div>
            <div class="modal-body">
                <button id="settings-routine-btn">Îß§Ïùº Î£®Ìã¥ ÏÑ§Ï†ï</button>
                <hr style="border: 0; border-top: 1px solid #eee; margin: 15px 0;">
                <button id="settings-backup-btn">Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞ Î∞±ÏóÖ</button>
                <label for="import-file-input" id="import-data-label">Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞ Î∂àÎü¨Ïò§Í∏∞</label>
                <input type="file" id="import-file-input" accept=".json" style="display: none;">
                <hr style="border: 0; border-top: 1px solid #eee; margin: 15px 0;">
                <button id="settings-delete-all-btn" class="danger">Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú</button>
            </div>
        </div>
    </div>
    
    <div id="routine-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h4>Îß§Ïùº Î£®Ìã¥ ÏÑ§Ï†ï</h4>
                <button id="close-routine-modal" class="modal-close-btn" aria-label="Îã´Í∏∞">&times;</button>
            </div>
            <div class="modal-body">
                <label for="routine-input">Îß§Ïùº Î∞òÎ≥µÌï† Ìï† Ïùº (Ìïú Ï§ÑÏóê ÌïòÎÇòÏî©)</label>
                <textarea id="routine-input" placeholder="Ïòà: Î¨º 1L ÎßàÏãúÍ∏∞"></textarea>
                <button id="save-routine-btn">Î£®Ìã¥ Ï†ÄÏû•</button>
            </div>
        </div>
    </div>


    <script>
        // (JS ÎùºÏù¥Î∏åÎü¨Î¶¨ Î°úÎìú ÌôïÏù∏)
        window.jsPDF = window.jspdf.jsPDF;

        // --- HTML ÏöîÏÜå ---
        const newTaskInput = document.getElementById('new-task-input');
        const addTaskBtn = document.getElementById('add-task-btn');
        const todoList = document.getElementById('todo-list');
        const importantList = document.getElementById('important-list');
        const timeline = document.getElementById('timeline');
        const dateDisplay = document.getElementById('current-date');
        const prevDayBtn = document.getElementById('prev-day');
        const nextDayBtn = document.getElementById('next-day');
        const calendarBtn = document.getElementById('calendar-btn');
        const planContainer = document.getElementById('plan-container');
        const memoBtn = document.getElementById('memo-btn');
        const memoContainer = document.getElementById('memo-container');
        const memoTextarea = document.getElementById('memo-textarea');
        const searchInput = document.getElementById('search-input');
        const searchBtn = document.getElementById('search-btn');
        const searchResultsModal = document.getElementById('search-results-modal');
        const closeSearchModalBtn = document.getElementById('close-search-modal');
        const searchResultsList = document.getElementById('search-results-list');
        const playgroundBtn = document.getElementById('playground-btn');
        const playgroundContainer = document.getElementById('playground-container');
        const newGoalInput = document.getElementById('new-goal-input');
        const addGoalBtn = document.getElementById('add-goal-btn');
        const goalList = document.getElementById('goal-list');
        const goalProgressView = document.getElementById('goal-progress-view');
        const goalProgressPlaceholder = document.getElementById('goal-progress-placeholder');
        const goalProgressContent = document.getElementById('goal-progress-content');
        const goalProgressNotes = document.getElementById('goal-progress-notes');
        const goalImageUpload = document.getElementById('goal-image-upload');
        const goalProgressImages = document.getElementById('goal-progress-images');
        const exportGoalPdfBtn = document.getElementById('export-goal-pdf-btn');
        const weightBtn = document.getElementById('weight-btn');
        const graphBtn = document.getElementById('graph-btn');
        const weightContainer = document.getElementById('weight-container');
        const newWeightInput = document.getElementById('new-weight-input');
        const newAlcoholInput = document.getElementById('new-alcohol-input'); // ‚òÖ ÏùåÏ£ºÎüâ ÏûÖÎ†•
        const addWeightBtn = document.getElementById('add-weight-btn');
        const weightList = document.getElementById('weight-list');
        const graphContainer = document.getElementById('graph-container');
        const graphRangeLabel = document.getElementById('graph-range-label');
        const weightChartCanvas = document.getElementById('weight-chart');
        
        const todayBtn = document.getElementById('today-btn');
        const settingsBtn = document.getElementById('settings-btn');
        const settingsModal = document.getElementById('settings-modal');
        const closeSettingsModalBtn = document.getElementById('close-settings-modal');
        const settingsRoutineBtn = document.getElementById('settings-routine-btn');
        const settingsBackupBtn = document.getElementById('settings-backup-btn');
        const importDataLabel = document.getElementById('import-data-label');
        const importFileInput = document.getElementById('import-file-input');
        const settingsDeleteAllBtn = document.getElementById('settings-delete-all-btn');
        const routineModal = document.getElementById('routine-modal');
        const closeRoutineModalBtn = document.getElementById('close-routine-modal');
        const routineInput = document.getElementById('routine-input');
        const saveRoutineBtn = document.getElementById('save-routine-btn');
        const applyRoutineBtn = document.getElementById('apply-routine-btn');
        const importWeightFile = document.getElementById('import-weight-file');

        // --- ÏÉÅÌÉú Î≥ÄÏàò ---
        let selectedTasks = []; 
        let draggedTaskItem = null;
        let currentDate = new Date();
        let calendarInstance = null;
        let playgroundData = { goals: [] };
        let selectedGoalId = null;
        const PLAYGROUND_KEY = 'playgroundData';
        let weightData = [];
        const WEIGHT_KEY = 'weightData';
        let chartRangeMode = 0;
        let currentChartInstance = null;
        let currentView = 'plan-container';
        const ROUTINE_KEY = 'dailyRoutines';

        // --- Î∑∞ Ï†ÑÌôò ---
        function showView(viewToShow) {
            planContainer.classList.add('hidden');
            memoContainer.classList.add('hidden');
            playgroundContainer.classList.add('hidden');
            weightContainer.classList.add('hidden');
            graphContainer.classList.add('hidden');
            document.getElementById(viewToShow).classList.remove('hidden');
            currentView = viewToShow;
            memoBtn.textContent = 'üìù';
            playgroundBtn.textContent = 'üèüÔ∏è';
            weightBtn.style.color = '#007aff';
            graphBtn.style.color = '#007aff';
            if (viewToShow === 'memo-container') memoBtn.textContent = 'üìã';
            if (viewToShow === 'playground-container') playgroundBtn.textContent = 'üìã';
            if (viewToShow === 'weight-container') {
                weightBtn.style.color = '#FF9500';
                newWeightInput.placeholder = `${getDateKey(currentDate)} Î™∏Î¨¥Í≤å (kg)`;
            }
            if (viewToShow === 'graph-container') graphBtn.style.color = '#FF9500';
            
            applyRoutineBtn.style.display = (viewToShow === 'plan-container') ? 'block' : 'none';
        }
        memoBtn.addEventListener('click', () => {
            if (memoContainer.classList.contains('hidden')) showView('memo-container');
            else showView('plan-container');
        });
        playgroundBtn.addEventListener('click', () => {
            if (playgroundContainer.classList.contains('hidden')) showView('playground-container');
            else showView('plan-container');
        });
        weightBtn.addEventListener('click', () => {
            if (weightContainer.classList.contains('hidden')) showView('weight-container');
            else showView('plan-container');
        });
        
        graphBtn.addEventListener('click', () => {
            if (graphContainer.classList.contains('hidden')) {
                chartRangeMode = 0;
            } else {
                chartRangeMode = (chartRangeMode + 1) % 6;
            }
            renderWeightChart();
            showView('graph-container');
        });
        
        // --- Í∏∞Î≥∏ Í∏∞Îä• ---
        todayBtn.addEventListener('click', () => changeDate(new Date()));
        settingsBtn.addEventListener('click', () => settingsModal.classList.remove('hidden'));
        closeSettingsModalBtn.addEventListener('click', () => settingsModal.classList.add('hidden'));
        settingsRoutineBtn.addEventListener('click', () => {
            const currentRoutines = JSON.parse(localStorage.getItem(ROUTINE_KEY) || '[]');
            routineInput.value = currentRoutines.join('\n');
            routineModal.classList.remove('hidden');
        });
        closeRoutineModalBtn.addEventListener('click', () => routineModal.classList.add('hidden'));
        
        saveRoutineBtn.addEventListener('click', () => {
            const newRoutines = routineInput.value.split('\n').map(r => r.trim()).filter(r => r.length > 0);
            localStorage.setItem(ROUTINE_KEY, JSON.stringify(newRoutines));
            routineModal.classList.add('hidden');
            settingsModal.classList.add('hidden');
            alert("Î£®Ìã¥ ÌÖúÌîåÎ¶øÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§. 'Î®∏Î¶øÏÜç Ìï† Ïùº'Ïùò üîÑ Î≤ÑÌäºÏúºÎ°ú Ï†ÅÏö©/ÏÇ≠Ï†úÌïòÏÑ∏Ïöî.");
        });
        
        applyRoutineBtn.addEventListener('click', () => {
            const currentRoutines = JSON.parse(localStorage.getItem(ROUTINE_KEY) || '[]');
            const routineItemsInList = todoList.querySelectorAll('.routine-item');

            if (routineItemsInList.length > 0) {
                if (!confirm("ÌòÑÏû¨ ÎÇ†ÏßúÏùò Î£®Ìã¥ÏùÑ Î™©Î°ùÏóêÏÑú ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) return;
                routineItemsInList.forEach(item => {
                    const taskText = item.querySelector('span').textContent;
                    selectedTasks = selectedTasks.filter(task => task !== taskText);
                    item.remove();
                });
                updateImportantList();
            } else {
                if (currentRoutines.length === 0) {
                    alert("ÏÑ§Ï†ï(‚öôÔ∏è)ÏóêÏÑú 'Îß§Ïùº Î£®Ìã¥'ÏùÑ Î®ºÏ†Ä Îì±Î°ùÌï¥Ï£ºÏÑ∏Ïöî.");
                    return;
                }
                const existingTasks = new Set(
                    Array.from(todoList.children).map(item => item.querySelector('span').textContent)
                );
                let addedCount = 0;
                currentRoutines.slice().reverse().forEach(routineText => {
                    if (!existingTasks.has(routineText)) {
                        addNewTask(routineText, false, false, true, true); 
                        addedCount++;
                    }
                });
                if (addedCount === 0) {
                    alert("Î™®Îì† Î£®Ìã¥Ïù¥ Ïù¥ÎØ∏ Î™©Î°ùÏóê ÏûàÏäµÎãàÎã§.");
                }
            }
            savePlanData(); 
            checkRoutineBtnState(); 
        });

        settingsBackupBtn.addEventListener('click', () => {
            const backupData = {
                plans: {},
                playground: JSON.parse(localStorage.getItem(PLAYGROUND_KEY) || '{}'),
                weight: JSON.parse(localStorage.getItem(WEIGHT_KEY) || '[]'),
                routines: JSON.parse(localStorage.getItem(ROUTINE_KEY) || '[]')
            };
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('plan_')) {
                    backupData.plans[key] = JSON.parse(localStorage.getItem(key));
                }
            }
            const dataStr = JSON.stringify(backupData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `plan_backup_${getDateKey(new Date())}.json`;
            a.click();
            URL.revokeObjectURL(url);
            settingsModal.classList.add('hidden');
        });
        importDataLabel.addEventListener('click', () => importFileInput.click());
        importFileInput.addEventListener('change', (e) => {
            if (!e.target.files.length) return;
            if (!confirm("Í≤ΩÍ≥†: ÌòÑÏû¨ Î™®Îì† Îç∞Ïù¥ÌÑ∞Î•º ÎçÆÏñ¥Ïì∞Í≥† Î≥µÍµ¨Ìï©ÎãàÎã§. Í≥ÑÏÜçÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) return;
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const parsedData = JSON.parse(event.target.result);
                    localStorage.clear();
                    localStorage.setItem(PLAYGROUND_KEY, JSON.stringify(parsedData.playground || {}));
                    localStorage.setItem(WEIGHT_KEY, JSON.stringify(parsedData.weight || []));
                    localStorage.setItem(ROUTINE_KEY, JSON.stringify(parsedData.routines || []));
                    if (parsedData.plans) {
                        for (const key in parsedData.plans) {
                            localStorage.setItem(key, JSON.stringify(parsedData.plans[key]));
                        }
                    }
                    alert("Îç∞Ïù¥ÌÑ∞Î•º ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î∂àÎü¨ÏôîÏäµÎãàÎã§. Ïï±ÏùÑ ÏÉàÎ°úÍ≥†Ïπ®Ìï©ÎãàÎã§.");
                    location.reload();
                } catch (err) {
                    alert("Ïò§Î•ò: ÏûòÎ™ªÎêú Î∞±ÏóÖ ÌååÏùºÏûÖÎãàÎã§.");
                }
            };
            reader.readAsText(file);
            settingsModal.classList.add('hidden');
        });
        settingsDeleteAllBtn.addEventListener('click', () => {
            if (!confirm("Í≤ΩÍ≥†: Ïù¥ Ïï±Ïùò Î™®Îì† Îç∞Ïù¥ÌÑ∞(Í≥ÑÌöç, Î™©Ìëú, Î™∏Î¨¥Í≤å)Í∞Ä ÏòÅÍµ¨Ï†ÅÏúºÎ°ú ÏÇ≠Ï†úÎê©ÎãàÎã§. Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) return;
            localStorage.clear();
            alert("Î™®Îì† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§. Ïï±ÏùÑ ÏÉàÎ°úÍ≥†Ïπ®Ìï©ÎãàÎã§.");
            location.reload();
        });


        function getDateKey(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        function getStorageKey(date) { return `plan_${getDateKey(date)}`; }
        
        function savePlanData() {
            const key = getStorageKey(currentDate);
            const todos = Array.from(todoList.children).map(item => ({
                text: item.querySelector('span').textContent,
                checked: item.querySelector('input[type="checkbox"]').checked,
                isImportant: item.classList.contains('is-important'),
                isRoutine: item.classList.contains('routine-item')
            }));
            const timelineTasks = {};
            timeline.querySelectorAll('.time-slot').forEach(slot => {
                const time = slot.dataset.time;
                const tasks = Array.from(slot.querySelectorAll('.dropped-task')).map(task => ({
                    text: task.childNodes[0].nodeValue,
                    isImportant: task.classList.contains('is-important')
                }));
                if (tasks.length > 0) timelineTasks[time] = tasks;
            });
            const memoText = memoTextarea.value;
            const data = { todos, timelineTasks, selectedTasks, memoText };
            
            if (data.todos.length === 0 && Object.keys(timelineTasks).length === 0 && memoText.trim() === '') {
                localStorage.removeItem(key);
            } else {
                localStorage.setItem(key, JSON.stringify(data));
            }
            
            if (calendarInstance) { calendarInstance.redraw(); }
        }
        
        function loadPlanData() {
            const key = getStorageKey(currentDate);
            const data = JSON.parse(localStorage.getItem(key));
            
            todoList.innerHTML = '';
            importantList.innerHTML = '';
            timeline.querySelectorAll('.dropped-task').forEach(task => task.remove());
            memoTextarea.value = '';
            
            let finalTodoList = [];
            
            if (data) {
                finalTodoList = data.todos || [];
            }

            // ‚òÖ ÏàòÏ†ïÎêú Î°úÏßÅ: Ï†ÄÏû•Îêú ÏàúÏÑú Í∑∏ÎåÄÎ°ú Î≥µÏõê (Ï§ëÎ≥µ Î∞©ÏßÄ, ÏàúÏÑú Ïú†ÏßÄ)
            finalTodoList.forEach(t => {
                addNewTask(t.text, t.checked, t.isImportant, t.isRoutine);
            });
            
            if (data) {
                selectedTasks = data.selectedTasks || [];
                if (data.timelineTasks) {
                    for (const [time, tasks] of Object.entries(data.timelineTasks)) {
                        const timeSlot = timeline.querySelector(`[data-time="${time}"]`);
                        if (timeSlot) {
                            tasks.forEach(taskData => {
                                // Î£®Ìã¥ Ïó¨Î∂ÄÎäî Î™©Î°ùÏóêÏÑú ÌôïÏù∏ÌïòÏßÄ ÏïäÍ≥†, Ï†ÄÏû•Îêú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏúºÎ©¥ false (Ìò∏ÌôòÏÑ±)
                                // ÌòÑÏû¨ Î°úÏßÅÏÉÅ Î™©Î°ùÏóê ÏûàÏñ¥Ïïº ÎìúÎûòÍ∑∏ Í∞ÄÎä•ÌïòÎØÄÎ°ú ÌÅ∞ Î¨∏Ï†ú ÏóÜÏùå.
                                createDroppedTaskElement(timeSlot, taskData.text, taskData.isImportant, false); 
                            });
                        }
                    }
                }
                if (data.memoText) { memoTextarea.value = data.memoText; }
            } else {
                selectedTasks = [];
            }
            
            updateImportantList();
            checkRoutineBtnState();
        }
        
        function checkRoutineBtnState() {
            const routineItemsInList = todoList.querySelectorAll('.routine-item');
            if (routineItemsInList.length > 0) {
                applyRoutineBtn.classList.add('active'); 
                applyRoutineBtn.title = "Îß§Ïùº Î£®Ìã¥ ÏÇ≠Ï†ú";
            } else {
                applyRoutineBtn.classList.remove('active');
                applyRoutineBtn.title = "Îß§Ïùº Î£®Ìã¥ Ï†ÅÏö©";
            }
        }

        memoTextarea.addEventListener('input', savePlanData);

        searchBtn.addEventListener('click', performSearch);
        searchInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') performSearch(); });
        closeSearchModalBtn.addEventListener('click', () => { searchResultsModal.classList.add('hidden'); });
        function performSearch() {
            const query = searchInput.value.trim().toLowerCase();
            if (query === '') return;
            searchResultsList.innerHTML = '';
            const results = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('plan_')) {
                    const data = JSON.parse(localStorage.getItem(key));
                    const dateStr = key.substring(5);
                    if (data.memoText && data.memoText.toLowerCase().includes(query)) {
                        results.push({ date: dateStr, match: 'Î©îÎ™®: ' + data.memoText.substring(0, 80) + '...' });
                    }
                    if (data.todos) {
                        data.todos.forEach(todo => {
                            if (todo.text.toLowerCase().includes(query)) {
                                results.push({ date: dateStr, match: 'Ìï†Ïùº: ' + todo.text });
                            }
                        });
                    }
                }
            }
            displaySearchResults(results, query);
        }
        function displaySearchResults(results, query) {
            if (results.length === 0) {
                searchResultsList.innerHTML = `<li style="padding: 10px; text-align: center;">'${query}'Ïóê ÎåÄÌïú Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.</li>`;
            } else {
                results.forEach(result => {
                    const li = document.createElement('li');
                    li.classList.add('search-result-item');
                    li.innerHTML = `<small>${result.date}</small><p>${result.match}</p>`;
                    li.addEventListener('click', () => {
                        const newDate = new Date(result.date + 'T00:00:00');
                        changeDate(newDate);
                        searchResultsModal.classList.add('hidden');
                    });
                    searchResultsList.appendChild(li);
                });
            }
            searchResultsModal.classList.remove('hidden');
        }

        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const week = ['Ïùº', 'Ïõî', 'Ìôî', 'Ïàò', 'Î™©', 'Í∏à', 'ÌÜ†'][date.getDay()];
            return `${year}.${month}.${day} (${week})`;
        }
        function updateDateDisplay() {
            dateDisplay.textContent = formatDate(currentDate);
            if (calendarInstance) { calendarInstance.setDate(currentDate, false); }
        }
        function refreshCurrentViewData() {
            showView(currentView);
            
            switch (currentView) {
                case 'plan-container':
                case 'memo-container':
                    loadPlanData();
                    break;
                case 'weight-container':
                    loadWeightData();
                    break;
                case 'graph-container':
                    renderWeightChart();
                    break;
                case 'playground-container':
                    break;
            }
        }
        function changeDate(newDate) {
            currentDate = newDate;
            updateDateDisplay();
            refreshCurrentViewData();
        }
        prevDayBtn.addEventListener('click', () => {
            const newDate = new Date(currentDate);
            newDate.setDate(newDate.getDate() - 1);
            changeDate(newDate);
        });
        nextDayBtn.addEventListener('click', () => {
            const newDate = new Date(currentDate);
            newDate.setDate(newDate.getDate() + 1);
            changeDate(newDate);
        });

        function createTimeline() {
            timeline.innerHTML = ''; 
            for (let hour = 6; hour <= 22; hour++) {
                const timeSlot = document.createElement('div');
                timeSlot.classList.add('time-slot');
                timeSlot.dataset.time = `${hour}:00`; 
                const timeLabel = document.createElement('span');
                timeLabel.classList.add('time-label');
                timeLabel.textContent = `${hour}:00`;
                timeSlot.appendChild(timeLabel);
                addDropListeners(timeSlot);
                timeline.appendChild(timeSlot);
            }
        }
        
        function deleteTaskGlobally(taskText) {
            const originalTaskItem = Array.from(todoList.children).find(
                item => item.querySelector('span').textContent === taskText
            );
            
            if (originalTaskItem && originalTaskItem.classList.contains('routine-item')) {
                alert("Îß§Ïùº Î£®Ìã¥ÏùÄ 'ÏÑ§Ï†ï > Îß§Ïùº Î£®Ìã¥ ÏÑ§Ï†ï'ÏóêÏÑú ÏàòÏ†ïÌïòÍ±∞ÎÇò, üîÑ Î≤ÑÌäºÏúºÎ°ú ÌòÑÏû¨ ÎÇ†ÏßúÏóêÏÑúÎßå ÏÇ≠Ï†úÌï† Ïàò ÏûàÏäµÎãàÎã§.");
                return;
            }

            selectedTasks = selectedTasks.filter(task => task !== taskText);
            updateImportantList();
            
            const timelineTasks = timeline.querySelectorAll('.dropped-task');
            timelineTasks.forEach(task => {
                if (task.childNodes[0].nodeValue === taskText) {
                    task.remove();
                }
            });
            
            if (originalTaskItem) {
                originalTaskItem.remove();
            }
            savePlanData();
        }

        addTaskBtn.addEventListener('click', () => addNewTask(null, false, false, false, true)); 
        newTaskInput.addEventListener('keypress', function(e) { 
            if (e.key === 'Enter') addNewTask(null, false, false, false, true); 
        });
        
        function addNewTask(taskText = null, isChecked = false, isImportant = false, isRoutine = false, isNewEntry = false) {
            if (taskText === null) {
                taskText = newTaskInput.value.trim();
                if (taskText === '') return;
                
                const currentRoutines = JSON.parse(localStorage.getItem(ROUTINE_KEY) || '[]');
                if (currentRoutines.includes(taskText) || Array.from(todoList.children).some(item => item.querySelector('span').textContent === taskText)) {
                    alert("Ïù¥ÎØ∏ Î™©Î°ùÏóê ÏûàÎäî Ìï≠Î™©ÏûÖÎãàÎã§.");
                    newTaskInput.value = '';
                    return;
                }
                newTaskInput.value = '';
            }
            
            const taskItem = document.createElement('li');
            taskItem.classList.add('task-item');
            if (isRoutine) taskItem.classList.add('routine-item');
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            const taskSpan = document.createElement('span');
            taskSpan.textContent = taskText;
            // ‚òÖ 3. ÏàòÏ†ï Í∏∞Îä• (contentEditable)
            taskSpan.contentEditable = "true";
            taskSpan.addEventListener('blur', () => {
                // ÏàòÏ†ï ÏôÑÎ£å Ïãú Ï†ÄÏû• (Í∏∞Ï°¥ ÌÖçÏä§Ìä∏Î°ú Ìï≠Î™© Ï∞æÍ∏∞Í∞Ä Ïñ¥Î†§Ïö∞ÎØÄÎ°ú Ï†ÑÏ≤¥ Ï†ÄÏû•)
                savePlanData();
            });
            taskSpan.addEventListener('keypress', (e) => {
                 if (e.key === 'Enter') { e.preventDefault(); taskSpan.blur(); }
            });

            const deleteBtn = document.createElement('button');
            deleteBtn.classList.add('delete-btn');
            deleteBtn.innerHTML = '&times;';
            deleteBtn.setAttribute('aria-label', 'ÏÇ≠Ï†ú');
            
            taskItem.appendChild(checkbox);
            taskItem.appendChild(taskSpan);
            taskItem.appendChild(deleteBtn);
            
            // ‚òÖ 1. Î£®Ìã¥ÎèÑ ÎìúÎûòÍ∑∏ Í∞ÄÎä•
            taskItem.draggable = true;
            taskItem.addEventListener('dragstart', (e) => {
                draggedTaskItem = taskItem;
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', taskText);
                setTimeout(() => { taskItem.style.opacity = '0.5'; }, 0);
            });
            taskItem.addEventListener('dragend', () => {
                if (draggedTaskItem) { draggedTaskItem.style.opacity = '1'; }
                draggedTaskItem = null;
            });
            taskSpan.addEventListener('click', () => {
                toggleTaskSelection(taskItem, taskText);
            });

            if (isRoutine) {
                deleteBtn.style.display = 'none'; 
            } else {
                deleteBtn.addEventListener('click', () => {
                    deleteTaskGlobally(taskText);
                });
            }

            checkbox.addEventListener('change', () => {
                taskItem.classList.toggle('completed', checkbox.checked);
                savePlanData(); 
            });

            if (isImportant) { taskItem.classList.add('is-important', 'selected'); }
            if (isChecked) {
                checkbox.checked = true;
                taskItem.classList.add('completed');
            }
            
            if (isNewEntry && isRoutine) {
                todoList.prepend(taskItem);
            } else {
                todoList.appendChild(taskItem);
            }

            if (isNewEntry) { savePlanData(); }
        }

        function toggleTaskSelection(taskItem, taskText) {
            const isSelected = taskItem.classList.contains('selected');
            if (isSelected) {
                taskItem.classList.remove('selected', 'is-important');
                selectedTasks = selectedTasks.filter(task => task !== taskText);
            } else {
                if (selectedTasks.length < 5) {
                    taskItem.classList.add('selected', 'is-important');
                    selectedTasks.push(taskText);
                } else {
                    alert('Ï§ëÏöîÌïú 5Í∞ÄÏßÄÎßå ÏÑ†ÌÉùÌï† Ïàò ÏûàÏäµÎãàÎã§.');
                }
            }
            updateImportantList();
            savePlanData();
        }
        function updateImportantList() {
            importantList.innerHTML = ''; 
            selectedTasks.forEach(taskText => {
                const draggableTask = document.createElement('div');
                draggableTask.classList.add('draggable-task');
                draggableTask.textContent = taskText;
                draggableTask.draggable = true; 
                draggableTask.addEventListener('dragstart', (e) => {
                    draggedTaskItem = draggableTask;
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', taskText);
                    setTimeout(() => { draggableTask.style.opacity = '0.5'; }, 0);
                });
                draggableTask.addEventListener('dragend', () => {
                    if (draggedTaskItem) { draggableTask.style.opacity = '1'; }
                    draggedTaskItem = null;
                });
                importantList.appendChild(draggableTask);
            });
        }

        function createDroppedTaskElement(timeSlot, text, isImportant, isRoutine) {
            const droppedTask = document.createElement('div');
            droppedTask.classList.add('dropped-task');
            droppedTask.classList.toggle('is-important', isImportant);
            droppedTask.classList.toggle('is-general', !isImportant);
            
            droppedTask.appendChild(document.createTextNode(text));

            droppedTask.draggable = true;
            droppedTask.addEventListener('dragstart', (e) => {
                draggedTaskItem = droppedTask;
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', text);
                setTimeout(() => { droppedTask.style.opacity = '0.5'; }, 0);
            });
            droppedTask.addEventListener('dragend', () => {
                if (draggedTaskItem) { droppedTask.style.opacity = '1'; }
                draggedTaskItem = null;
            });
            
            droppedTask.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation(); 
                timeSlot.classList.add('drag-over');
            });
            droppedTask.addEventListener('dragleave', (e) => {
                e.stopPropagation();
                timeSlot.classList.remove('drag-over');
            });
            
            // ‚òÖ 1. ÏãúÍ∞ÑÌëú Ìï≠Î™© ÏÇ≠Ï†ú Î≤ÑÌäº (Î™®Îëê ÌëúÏãú)
            const deleteBtn = document.createElement('button');
            deleteBtn.classList.add('timeline-delete-btn');
            deleteBtn.innerHTML = '&times;';
            deleteBtn.setAttribute('aria-label', 'ÏÇ≠Ï†ú');
            
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                deleteTaskGlobally(text);
            });

            droppedTask.appendChild(deleteBtn);
            timeSlot.appendChild(droppedTask);
        }
        function addDropListeners(timeSlot) {
            timeSlot.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                timeSlot.classList.add('drag-over');
            });
            timeSlot.addEventListener('dragleave', () => {
                timeSlot.classList.remove('drag-over');
            });
            timeSlot.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                const targetSlot = e.target.closest('.time-slot');
                if (!targetSlot) return; 
                
                targetSlot.classList.remove('drag-over');
                if (!draggedTaskItem) return;

                const taskText = draggedTaskItem.textContent.replace('√ó', '').trim();

                if (draggedTaskItem.classList.contains('dropped-task')) {
                    draggedTaskItem.style.opacity = '1';
                    targetSlot.appendChild(draggedTaskItem);
                }
                else if (draggedTaskItem.classList.contains('task-item') || draggedTaskItem.classList.contains('draggable-task')) {
                    let isImportant = false;
                    let isRoutine = false; 
                    let originalTaskItem = null;
                    
                    if (draggedTaskItem.classList.contains('task-item')) {
                        originalTaskItem = draggedTaskItem;
                    } else { 
                        originalTaskItem = Array.from(todoList.children).find(
                            item => item.querySelector('span').textContent === taskText
                        );
                    }
                    
                    if (originalTaskItem) {
                        isImportant = originalTaskItem.classList.contains('is-important');
                        isRoutine = originalTaskItem.classList.contains('routine-item');
                        
                        originalTaskItem.classList.add('completed');
                        const checkbox = originalTaskItem.querySelector('input[type="checkbox"]');
                        if (checkbox) checkbox.checked = true;
                        
                        // ‚òÖ 1. Î≥µÏÇ¨Ïù¥ÎØÄÎ°ú ÏõêÎ≥∏ ÎπÑÌôúÏÑ±Ìôî Î°úÏßÅ Ï†úÍ±∞
                    } else if (draggedTaskItem.classList.contains('draggable-task')) {
                        isImportant = true;
                    }

                    createDroppedTaskElement(targetSlot, taskText, isImportant, isRoutine);
                    
                    // ‚òÖ 1. 'Ï§ëÏöîÌïú 5Í∞ÄÏßÄ'ÏóêÏÑú ÎìúÎûòÍ∑∏ Ïãú Î™©Î°ùÏóêÏÑú Ï†úÍ±∞
                    if (draggedTaskItem.classList.contains('draggable-task')) {
                        selectedTasks = selectedTasks.filter(task => task !== taskText);
                        updateImportantList();
                    }
                }
                draggedTaskItem = null;
                savePlanData();
            });
        }

        // --- ÎÜÄÏù¥ÌÑ∞, Î™∏Î¨¥Í≤å Îì± Í∏∞Ï°¥ Í∏∞Îä• Ïú†ÏßÄ ---
        function savePlaygroundData() {
            if (selectedGoalId) {
                const goal = playgroundData.goals.find(g => g.id === selectedGoalId);
                if (goal) { goal.progressNotes = goalProgressNotes.value; }
            }
            localStorage.setItem(PLAYGROUND_KEY, JSON.stringify(playgroundData));
        }
        function loadPlaygroundData() {
            const data = JSON.parse(localStorage.getItem(PLAYGROUND_KEY));
            if (data) { playgroundData = data; }
            renderGoalList();
            showGoalProgress(null);
        }
        function renderGoalList() {
            goalList.innerHTML = '';
            playgroundData.goals.forEach(goal => {
                const li = document.createElement('li');
                li.classList.add('goal-item');
                li.dataset.id = goal.id;
                li.classList.toggle('completed', goal.checked);
                li.classList.toggle('selected', goal.id === selectedGoalId);
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = goal.checked;
                checkbox.addEventListener('change', () => {
                    goal.checked = checkbox.checked;
                    li.classList.toggle('completed', goal.checked);
                    savePlaygroundData();
                });
                const span = document.createElement('span');
                span.textContent = goal.text;
                span.contentEditable = "true";
                span.addEventListener('blur', () => {
                    goal.text = span.textContent;
                    savePlaygroundData();
                });
                span.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') { e.preventDefault(); span.blur(); }
                });
                const deleteBtn = document.createElement('button');
                deleteBtn.classList.add('delete-btn');
                deleteBtn.innerHTML = '&times;';
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    playgroundData.goals = playgroundData.goals.filter(g => g.id !== goal.id);
                    savePlaygroundData();
                    renderGoalList();
                    if (selectedGoalId === goal.id) { showGoalProgress(null); }
                });
                li.appendChild(checkbox);
                li.appendChild(span);
                li.appendChild(deleteBtn);
                li.addEventListener('click', () => { showGoalProgress(goal.id); });
                goalList.appendChild(li);
            });
        }
        function addNewGoal() {
            const text = newGoalInput.value.trim();
            if (text === '') return;
            const newGoal = {
                id: crypto.randomUUID(), text: text, checked: false, progressNotes: "",
                images: []
            };
            playgroundData.goals.push(newGoal);
            savePlaygroundData();
            renderGoalList();
            newGoalInput.value = '';
        }
        function showGoalProgress(goalId) {
            if (selectedGoalId) {
                const oldGoal = playgroundData.goals.find(g => g.id === selectedGoalId);
                if (oldGoal) { oldGoal.progressNotes = goalProgressNotes.value; }
                const oldLi = goalList.querySelector(`[data-id="${selectedGoalId}"]`);
                if (oldLi) oldLi.classList.remove('selected');
            }
            selectedGoalId = goalId;
            if (goalId === null) {
                goalProgressPlaceholder.classList.remove('hidden');
                goalProgressContent.classList.add('hidden');
            } else {
                const goal = playgroundData.goals.find(g => g.id === goalId);
                const li = goalList.querySelector(`[data-id="${goalId}"]`);
                if (li) li.classList.add('selected');
                goalProgressPlaceholder.classList.add('hidden');
                goalProgressContent.classList.remove('hidden');
                goalProgressNotes.value = goal.progressNotes;
                renderGoalImages();
            }
        }
        goalProgressNotes.addEventListener('input', savePlaygroundData);
        goalProgressNotes.addEventListener('paste', (e) => {
            if (!selectedGoalId) return;
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            for (const item of items) {
                if (item.type.indexOf('image') === 0) {
                    const file = item.getAsFile();
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        addImageToGoal(event.target.result);
                    };
                    reader.readAsDataURL(file);
                }
            }
        });
        function addImageToGoal(base64) {
            if (!selectedGoalId) return;
            const goal = playgroundData.goals.find(g => g.id === selectedGoalId);
            goal.images.push({ src: base64, size: '100' });
            savePlaygroundData();
            renderGoalImages();
        }
        function renderGoalImages() {
            goalProgressImages.innerHTML = '';
            if (!selectedGoalId) return;
            const goal = playgroundData.goals.find(g => g.id === selectedGoalId);
            goal.images.forEach((imgData, index) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'image-wrapper';
                const img = document.createElement('img');
                img.src = imgData.src;
                img.dataset.size = imgData.size;
                img.title = "ÌÅ¥Î¶≠ÌïòÏó¨ ÌÅ¨Í∏∞ Ï°∞Ï†à (100% > 75% > 50%)";
                img.addEventListener('click', () => { cycleImageSize(index); });
                const controls = document.createElement('div');
                controls.className = 'image-controls';
                const upBtn = document.createElement('button');
                upBtn.innerHTML = '‚Üë';
                upBtn.title = 'ÏúÑÎ°ú';
                if (index === 0) upBtn.disabled = true;
                upBtn.addEventListener('click', () => { moveImage(index, index - 1); });
                const downBtn = document.createElement('button');
                downBtn.innerHTML = '‚Üì';
                downBtn.title = 'ÏïÑÎûòÎ°ú';
                if (index === goal.images.length - 1) downBtn.disabled = true;
                downBtn.addEventListener('click', () => { moveImage(index, index + 1); });
                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = '&times;';
                deleteBtn.title = 'ÏÇ≠Ï†ú';
                deleteBtn.addEventListener('click', () => { deleteImage(index); });
                controls.appendChild(upBtn);
                controls.appendChild(downBtn);
                controls.appendChild(deleteBtn);
                wrapper.appendChild(img);
                wrapper.appendChild(controls);
                goalProgressImages.appendChild(wrapper);
            });
        }
        function moveImage(index1, index2) {
            const goal = playgroundData.goals.find(g => g.id === selectedGoalId);
            if (!goal) return;
            [goal.images[index1], goal.images[index2]] = [goal.images[index2], goal.images[index1]];
            savePlaygroundData();
            renderGoalImages();
        }
        function deleteImage(index) {
            const goal = playgroundData.goals.find(g => g.id === selectedGoalId);
            if (!goal) return;
            goal.images.splice(index, 1);
            savePlaygroundData();
            renderGoalImages();
        }
        function cycleImageSize(index) {
            const goal = playgroundData.goals.find(g => g.id === selectedGoalId);
            if (!goal) return;
            const currentSize = goal.images[index].size;
            let newSize = '100';
            if (currentSize === '100') newSize = '75';
            else if (currentSize === '75') newSize = '50';
            else if (currentSize === '50') newSize = '100';
            goal.images[index].size = newSize;
            savePlaygroundData();
            renderGoalImages();
        }
        goalImageUpload.addEventListener('change', (event) => {
            if (!selectedGoalId) return;
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => { addImageToGoal(e.target.result); };
            reader.readAsDataURL(file);
            goalImageUpload.value = '';
        });
        exportGoalPdfBtn.addEventListener('click', () => {
            if (!selectedGoalId) { alert("PDFÎ°ú ÎÇ¥Î≥¥ÎÇº Î™©ÌëúÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî."); return; }
            savePlaygroundData();
            const { jsPDF } = window.jspdf;
            const content = document.getElementById('goal-progress-content');
            const notesDiv = document.createElement('div');
            notesDiv.className = 'pdf-render-div';
            notesDiv.textContent = goalProgressNotes.value;
            goalProgressContent.insertBefore(notesDiv, goalProgressNotes);
            goalProgressNotes.classList.add('hidden');
            html2canvas(content, { scale: 2, useCORS: true }).then(canvas => {
                goalProgressContent.removeChild(notesDiv);
                goalProgressNotes.classList.remove('hidden');
                const imgData = canvas.toDataURL('image/png');
                const doc = new jsPDF('p', 'mm', 'a4');
                const imgProps = doc.getImageProperties(imgData);
                const pdfWidth = doc.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                let heightLeft = pdfHeight;
                let position = 0;
                const pageHeight = doc.internal.pageSize.getHeight();
                doc.addImage(imgData, 'PNG', 0, position, pdfWidth, pdfHeight);
                heightLeft -= pageHeight;
                while (heightLeft > 0) {
                    position = heightLeft - pdfHeight;
                    doc.addPage();
                    doc.addImage(imgData, 'PNG', 0, position, pdfWidth, pdfHeight);
                    heightLeft -= pageHeight;
                }
                const goal = playgroundData.goals.find(g => g.id === selectedGoalId);
                const fileName = goal ? `goal_${goal.text.substring(0, 20)}.pdf` : 'goal-progress.pdf';
                doc.save(fileName);
            });
        });

        function saveWeightData() {
            weightData.sort((a, b) => new Date(b.date) - new Date(a.date));
            localStorage.setItem(WEIGHT_KEY, JSON.stringify(weightData));
        }
        function loadWeightData() {
            const data = JSON.parse(localStorage.getItem(WEIGHT_KEY));
            if (data) { weightData = data; }
            renderWeightList();
            newWeightInput.placeholder = `${getDateKey(currentDate)} Î™∏Î¨¥Í≤å (kg)`;
        }
        function renderWeightList() {
            weightList.innerHTML = '';
            weightData.forEach((entry) => {
                const li = document.createElement('li');
                li.classList.add('weight-item');
                const textWrapper = document.createElement('div');
                const dateSpan = document.createElement('span');
                dateSpan.textContent = `${entry.date} `;
                dateSpan.style.color = "#555";
                const weightSpan = document.createElement('span');
                weightSpan.textContent = `${entry.weight} kg`;
                weightSpan.style.fontWeight = "600";
                weightSpan.style.color = "#007aff";
                const alcoholSpan = document.createElement('span');
                alcoholSpan.classList.add('weight-alcohol');
                if (entry.alcohol) alcoholSpan.textContent = `(${entry.alcohol})`;
                textWrapper.appendChild(dateSpan);
                textWrapper.appendChild(weightSpan);
                textWrapper.appendChild(alcoholSpan);
                const deleteBtn = document.createElement('button');
                deleteBtn.classList.add('delete-btn');
                deleteBtn.innerHTML = '&times;';
                deleteBtn.setAttribute('aria-label', 'ÏÇ≠Ï†ú');
                deleteBtn.addEventListener('click', () => {
                    deleteWeightEntry(entry.date);
                });
                li.appendChild(textWrapper);
                li.appendChild(deleteBtn);
                weightList.appendChild(li);
            });
        }
        function addNewWeight() {
            const weight = parseFloat(newWeightInput.value);
            if (!weight || weight <= 0) {
                alert("Ïò¨Î∞îÎ•∏ Î™∏Î¨¥Í≤åÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî.");
                return;
            }
            const alcohol = newAlcoholInput.value.trim();
            const dateKey = getDateKey(currentDate);
            const newEntry = { date: dateKey, weight: weight, alcohol: alcohol };
            const existingIndex = weightData.findIndex(e => e.date === dateKey);
            if (existingIndex > -1) {
                weightData[existingIndex] = newEntry;
            } else {
                weightData.push(newEntry);
            }
            saveWeightData();
            renderWeightList();
            newWeightInput.value = '';
            newAlcoholInput.value = '';
            newWeightInput.placeholder = `${dateKey} Î™∏Î¨¥Í≤å (kg)`;
        }
        function deleteWeightEntry(dateKey) {
            weightData = weightData.filter(e => e.date !== dateKey);
            saveWeightData();
            renderWeightList();
        }
        
        function handleWeightFileImport(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                const fileContent = event.target.result;
                const lines = fileContent.split('\n');
                let addedCount = 0;
                let updatedCount = 0;

                lines.forEach(line => {
                    const parts = line.trim().split(/\s+/);
                    if (parts.length < 2) return;

                    const dateStr = parts[0];
                    const weight = parseFloat(parts[1]);
                    const alcohol = parts.slice(2).join(' '); // ÎÇòÎ®∏ÏßÄ Îí∑Î∂ÄÎ∂ÑÏùÄ ÏùåÏ£ºÎüâ

                    if (!weight || weight <= 0) return;

                    const dateParts = dateStr.split(/[.-]/);
                    if (dateParts.length !== 3) return;

                    const [year, month, day] = dateParts;
                    if (year.length !== 4 || month.length > 2 || day.length > 2) return;

                    const formattedDateKey = `${year.padStart(4, '20')}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                    
                    if (!/^\d{4}-\d{2}-\d{2}$/.test(formattedDateKey)) return;

                    const existingIndex = weightData.findIndex(e => e.date === formattedDateKey);
                    if (existingIndex > -1) {
                        weightData[existingIndex].weight = weight;
                        if (alcohol) weightData[existingIndex].alcohol = alcohol;
                        updatedCount++;
                    } else {
                        weightData.push({ date: formattedDateKey, weight: weight, alcohol: alcohol });
                        addedCount++;
                    }
                });

                saveWeightData();
                renderWeightList();
                alert(`Îç∞Ïù¥ÌÑ∞ Î∂àÎü¨Ïò§Í∏∞ ÏôÑÎ£å: ${addedCount}Í∞ú Ï∂îÍ∞Ä, ${updatedCount}Í∞ú ÏóÖÎç∞Ïù¥Ìä∏`);
                importWeightFile.value = '';
            };
            reader.readAsText(file);
        }

        function renderWeightChart() {
            if (currentChartInstance) {
                currentChartInstance.destroy();
            }
            const rangeLabels = ['1Í∞úÏõî', '3Í∞úÏõî', '6Í∞úÏõî', '1ÎÖÑ', '5ÎÖÑ', '10ÎÖÑ'];
            const rangeMonths = [1, 3, 6, 12, 60, 120];
            
            graphRangeLabel.textContent = rangeLabels[chartRangeMode];
            
            const cutoff = new Date();
            cutoff.setMonth(cutoff.getMonth() - rangeMonths[chartRangeMode]);
            cutoff.setHours(0, 0, 0, 0);

            const today = new Date();
            const labels = [];
            const dataPoints = [];
            const pointColors = [];
            const fullDateLabels = [];
            
            const weightMap = new Map();
            weightData.forEach(entry => {
                weightMap.set(entry.date, entry);
            });

            let currentDay = new Date(cutoff);
            while (currentDay <= today) {
                const dateKey = getDateKey(currentDay);
                
                labels.push(currentDay.toLocaleDateString('ko-KR', { month: '2-digit', day: '2-digit' }));
                fullDateLabels.push(currentDay.toLocaleDateString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit' }));

                if (weightMap.has(dateKey)) {
                    const entry = weightMap.get(dateKey);
                    dataPoints.push(entry.weight);
                    // ‚òÖ 2. ÏùåÏ£º Ïãú Îπ®Í∞ÑÏÉâ, ÏïÑÎãàÎ©¥ ÌååÎûÄÏÉâ
                    pointColors.push(entry.alcohol ? '#ff3b30' : '#007aff');
                } else {
                    dataPoints.push(null);
                    pointColors.push('#007aff');
                }
                
                currentDay.setDate(currentDay.getDate() + 1);
            }
            
            const ctx = weightChartCanvas.getContext('2d');
            currentChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Î™∏Î¨¥Í≤å (kg)',
                        data: dataPoints,
                        borderColor: '#007aff',
                        backgroundColor: 'rgba(0,122,255,0.1)',
                        fill: true,
                        tension: 0.1,
                        pointRadius: 4,
                        pointBackgroundColor: pointColors, // ‚òÖ 2. Í∞úÎ≥Ñ Ï†ê ÏÉâÏÉÅ Ï†ÅÏö©
                        spanGaps: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: false } },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    const dataIndex = context[0].dataIndex;
                                    return fullDateLabels[dataIndex];
                                },
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y} kg`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // --- Îã¨Î†• Ï¥àÍ∏∞Ìôî ---
        function initializeCalendar() {
            if (typeof flatpickr === 'undefined') {
                console.error("Flatpickr ÎùºÏù¥Î∏åÎü¨Î¶¨Í∞Ä Î°úÎìúÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.");
                return;
            }
            calendarInstance = flatpickr(calendarBtn, {
                locale: "ko",
                allowInput: false,
                dateFormat: "Y-m-d",
                onChange: function(selectedDates) {
                    if (selectedDates.length > 0) { changeDate(selectedDates[0]); }
                },
                onDayCreate: function(d, dStr, fp, dayElem) {
                    const dateKey = getDateKey(dayElem.dateObj);
                    if (localStorage.getItem(`plan_${dateKey}`)) {
                        dayElem.classList.add('day-has-data');
                    }
                },
            });
        }

        // --- Ïï± Ï¥àÍ∏∞Ìôî ---
        function initializeApp() {
            createTimeline();
            updateDateDisplay();
            initializeCalendar();
            loadPlanData();
            loadPlaygroundData();
            addGoalBtn.addEventListener('click', addNewGoal);
            newGoalInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addNewGoal();
            });
            loadWeightData();
            addWeightBtn.addEventListener('click', addNewWeight);
            newWeightInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addNewWeight();
            });
            
            importWeightFile.addEventListener('change', handleWeightFileImport);
            
            searchResultsModal.classList.add('hidden');
            settingsModal.classList.add('hidden');
            routineModal.classList.add('hidden');
        }

        initializeApp();

    </script>
</body>
</html>