<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ì‹œê°„ ê´€ë¦¬ ì•± v9.2</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#007aff"> 

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ko.js"></script>

    <style>
        html, body {
            height: 100vh; height: 100dvh; margin: 0; padding: 0; overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #f4f4f9; font-size: 14px;
        }
        .app-container { display: flex; flex-direction: column; height: 100%; width: 100%; }
        .hidden { display: none !important; }

        /* --- í—¤ë” --- */
        #date-header {
            flex-shrink: 0; padding: 10px; background-color: #ffffff;
            border-bottom: 1px solid #e0e0e0; display: flex;
            justify-content: space-between; align-items: center;
        }
        #date-controls-left, #center-controls, #search-controls-right {
            display: flex;
            align-items: center;
        }
        #date-header button {
            background: none; border: none; font-size: 20px; font-weight: bold;
            color: #007aff; cursor: pointer; padding: 0 10px;
        }
        #current-date {
            min-width: 120px; text-align: center; font-size: 18px;
            font-weight: 600; color: #333;
        }
        #calendar-btn, #memo-btn, #today-btn { 
            font-size: 24px; padding: 0 5px; 
        }
        #center-controls button { font-size: 24px; padding: 0 8px; }
        #search-controls-right { justify-content: flex-end; }
        #playground-btn, #settings-btn { font-size: 24px; padding: 0 8px; }
        #search-input {
            border: 1px solid #ccc; border-radius: 4px; padding: 6px 8px;
            font-size: 14px; max-width: 100px;
        }
        #search-btn { font-size: 22px; padding: 0 8px; }

        /* --- ê³µí†µ íŒ¨ë„ ì»¨í…Œì´ë„ˆ --- */
        .main-container {
            display: flex; flex-grow: 1; width: 100%;
            background-color: #ffffff; overflow: hidden; min-height: 0;
        }
        .left-panel, .right-panel {
            flex: 1; padding: 10px; display: flex;
            flex-direction: column; min-width: 0;
        }
        .left-panel { border-right: 1px solid #e0e0e0; }
        .single-panel-view {
            padding: 10px; display: flex; flex-direction: column;
            flex-grow: 1; min-width: 100%; box-sizing: border-box;
        }

        h3 {
            margin-top: 0; margin-bottom: 8px; color: #333;
            padding-bottom: 4px;
            font-size: 16px; font-weight: 600; flex-shrink: 0;
        }
        .h3-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #eee;
            padding-bottom: 4px;
            margin-bottom: 8px;
        }
        .h3-wrapper h3 {
            margin-bottom: 0;
            border-bottom: none;
            padding-bottom: 0;
        }
        #apply-routine-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #007aff;
            padding: 0;
        }
        #apply-routine-btn.active {
            color: #FF9500;
        }
        #apply-routine-btn:hover { opacity: 0.7; }

        /* --- ë©”ëª¨ ì»¨í…Œì´ë„ˆ --- */
        #memo-textarea {
            width: 100%; height: 100%; border: 1px solid #e0e0e0;
            border-radius: 4px; padding: 10px; font-size: 15px;
            font-family: inherit; box-sizing: border-box; resize: none;
        }

        /* --- ê³„íší‘œ: í•  ì¼ ì„¹ì…˜ --- */
        #todo-section { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            min-height: 120px; /* ìµœì†Œ ë†’ì´ ì„¤ì • (í—¤ë”+ì…ë ¥ì°½ í™•ë³´) */
            overflow: hidden; /* ë‚´ë¶€ ìš”ì†Œ ë„˜ì¹¨ ë°©ì§€ */
        }
        .input-section { display: flex; margin-bottom: 10px; flex-shrink: 0; gap: 5px; }
        .input-section input[type="text"],
        .input-section input[type="number"] {
            flex-grow: 1; border: 1px solid #ccc; border-radius: 4px;
            padding: 8px 10px; font-size: 14px;
            min-width: 0; /* flex container ë‚´ë¶€ overflow ë°©ì§€ */
        }
        .input-section button {
            background-color: #007aff; color: white; border: none; border-radius: 4px;
            padding: 8px 12px; cursor: pointer;
            font-size: 16px; font-weight: bold;
            flex-shrink: 0;
        }
        #todo-list { 
            list-style: none; padding: 0; margin: 0; overflow-y: auto; flex-grow: 1;
            min-height: 400px; /* 10ì¤„ ì •ë„ ë””í´íŠ¸ë¡œ ë³´ì´ê²Œ ì„¤ì • */
        }
        .task-item {
            padding: 8px 10px;
            border: none;
            border-bottom: 1px solid #f0f0f0;
            border-radius: 0;
            margin-bottom: 5px;
            font-size: 14px;
            display: flex;
            align-items: center;
            transition: opacity 0.3s;
        }
        .routine-item {
            background-color: #fdfdfd;
        }
        .routine-item span::before {
            content: "ğŸ“Œ ";
            font-size: 12px;
            opacity: 0.6;
        }
        
        /* ìˆ˜ì • ê°€ëŠ¥í•˜ë„ë¡ outline ì œê±° */
        .task-item span { flex-grow: 1; cursor: pointer; margin-right: 5px; outline: none; }
        input[type="checkbox"] { margin-right: 8px; flex-shrink: 0; accent-color: #007aff; }
        .task-item.completed { opacity: 0.5; }
        .task-item.completed span { text-decoration: line-through; color: #888; }
        .task-item.is-important span { color: #d32f2f; font-weight: bold; }
        .delete-btn {
            background: none; border: none; color: #ff3b30; font-size: 22px;
            font-weight: 500; line-height: 1; cursor: pointer;
            padding: 0 2px 0 8px; margin-left: auto; flex-shrink: 0;
        }

        /* --- ê³„íší‘œ: íƒ€ì„ë¼ì¸ --- */
        #timeline-wrapper { flex-grow: 1; overflow-y: auto; }
        #timeline { position: relative; }
        .time-slot {
            min-height: 45px;
            height: auto;
            border-bottom: 1px solid #e0e0e0;
            position: relative;
            padding-left: 40px; 
            box-sizing: border-box;
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            align-items: flex-start;
            padding-top: 18px;
            padding-bottom: 4px;
        }
        .time-label {
            position: absolute;
            left: 3px;
            top: 5px;
            font-size: 11px;
            color: #888;
            font-weight: bold;
        }
        .time-slot.drag-over { background-color: #e0f7fa; }
        
        .dropped-task {
            display: inline-flex;
            align-items: center;
            padding: 2px 5px;
            font-size: 12px;
            margin-top: 2px;
            margin-right: 4px;
            font-weight: 500;
            cursor: grab;
            background-color: #E3F2FD;
            border: 1px solid #BBDEFB;
            border-radius: 4px;
            line-height: 1.2;
        }
        .dropped-task:active { cursor: grabbing; }
        .dropped-task.is-important { 
            color: #d32f2f;
            background-color: #FFEBEE;
            border-color: #FFCDD2;
        }
        .dropped-task.is-general { 
            color: #333;
            background-color: #E3F2FD;
            border-color: #BBDEFB;
        }
        
        .timeline-delete-btn {
            background: none;
            border: none;
            color: #aaa;
            font-size: 16px;
            font-weight: bold;
            line-height: 1;
            cursor: pointer;
            padding: 0 0 0 5px;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
        }
        .dropped-task:hover .timeline-delete-btn {
            opacity: 1;
            pointer-events: auto;
        }
        .timeline-delete-btn:hover {
            color: #ff3b30;
        }


        /* --- ë†€ì´í„°(Playground) ìŠ¤íƒ€ì¼ --- */
        #goal-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex-grow: 1; }
        .goal-item {
            padding: 10px; border: 1px solid #eee; border-radius: 4px;
            margin-bottom: 5px; font-size: 15px; display: flex;
            align-items: center; cursor: pointer;
        }
        .goal-item:hover { background-color: #f9f9f9; }
        .goal-item.selected { background-color: #eef8ff; border-color: #007aff; }
        .goal-item span { flex-grow: 1; outline: none; }
        .goal-item.completed span { text-decoration: line-through; color: #888; opacity: 0.7; }
        #goal-progress-view { display: flex; flex-direction: column; flex-grow: 1; min-height: 0; }
        #goal-progress-placeholder {
            flex-grow: 1; display: flex; align-items: center;
            justify-content: center; color: #aaa; font-size: 16px;
        }
        #goal-progress-content { display: flex; flex-direction: column; flex-grow: 1; min-height: 0; }
        #goal-progress-notes {
            width: 100%; height: 150px; border: 1px solid #e0e0e0;
            border-radius: 4px; padding: 10px; font-size: 15px;
            font-family: inherit; box-sizing: border-box; resize: vertical;
            margin-bottom: 10px; flex-shrink: 0;
        }
        #goal-progress-notes:focus { border-color: #007aff; box-shadow: 0 0 0 2px rgba(0,122,255,0.2); }
        #goal-image-controls {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 10px; flex-shrink: 0;
        }
        #goal-image-controls label {
            background-color: #007aff; color: white; padding: 8px 12px;
            border-radius: 4px; cursor: pointer; font-size: 14px;
        }
        #goal-image-controls input[type="file"] { display: none; }
        #export-goal-pdf-btn {
            background-color: #34c759; color: white; border: none;
            padding: 8px 12px; border-radius: 4px; font-size: 14px;
            font-weight: 600; cursor: pointer;
        }
        #goal-progress-images {
            flex-grow: 1; overflow-y: auto; border: 1px solid #eee;
            border-radius: 4px; padding: 5px; background: #fdfdfd;
        }
        .image-wrapper { position: relative; margin-bottom: 5px; line-height: 0; }
        .image-wrapper img {
            width: 100%; border-radius: 4px; cursor: pointer; transition: width 0.2s;
        }
        .image-wrapper img[data-size="100"] { width: 100%; }
        .image-wrapper img[data-size="75"] { width: 75%; }
        .image-wrapper img[data-size="50"] { width: 50%; }
        .image-controls {
            position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.5);
            border-radius: 4px; display: flex; opacity: 0; transition: opacity 0.2s;
        }
        .image-wrapper:hover .image-controls { opacity: 1; }
        .image-controls button {
            background: none; border: none; color: white; font-size: 18px;
            font-weight: bold; cursor: pointer; padding: 4px 8px;
        }
        .image-controls button:disabled { color: #888; cursor: not-allowed; }
        .image-controls button:hover:not(:disabled) { background: rgba(255,255,255,0.2); }
        .pdf-render-div {
            width: 100%; font-size: 15px; font-family: inherit; padding: 10px;
            box-sizing: border-box; background: white; white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* --- ëª¸ë¬´ê²Œ ê¸°ë¡ (ì‹œíŠ¸ íƒ€ì… ìŠ¤íƒ€ì¼) --- */
        #weight-sheet-wrapper {
            flex-grow: 1; overflow-y: auto; border: 1px solid #e0e0e0;
            border-radius: 4px; margin-top: 10px; background-color: #fff;
        }
        .sheet-table {
            width: 100%; border-collapse: collapse; min-width: 300px;
        }
        .sheet-table th, .sheet-table td {
            border: 1px solid #ddd; padding: 0;
            text-align: center; font-size: 14px; vertical-align: middle;
        }
        .sheet-table th {
            padding: 10px 5px; background-color: #f8f8f8; color: #555;
            font-weight: 600; position: sticky; top: 0; z-index: 10;
        }
        .sheet-table td {
            height: 40px;
        }
        .sheet-table input {
            width: 100%; height: 100%; border: none; text-align: center;
            font-size: 14px; background: transparent; padding: 0 5px;
            box-sizing: border-box; font-family: inherit;
        }
        .sheet-table input:focus {
            background-color: #eef8ff; outline: 2px solid #007aff; outline-offset: -2px;
        }
        .sheet-table .date-cell {
            background-color: #fdfdfd; color: #555; font-size: 13px;
        }
        .sheet-delete-btn {
            background: none; border: none; color: #ccc; font-size: 20px;
            cursor: pointer; width: 100%; height: 100%;
        }
        .sheet-delete-btn:hover { color: #ff3b30; background-color: #fff0f0; }
        
        #import-weight-label {
            display: inline-block;
            background-color: #8e8e93;
            color: white;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            text-align: center;
            width: auto;
            line-height: 1.4;
        }
        #import-weight-label:hover { opacity: 0.8; }

        /* --- ê·¸ë˜í”„ --- */
        #graph-chart-wrapper {
            flex-grow: 1; position: relative; min-height: 0;
        }
        #weight-chart { max-width: 100%; }

        /* --- ë‹¬ë ¥ --- */
        .flatpickr-day.day-has-data::after {
            content: "â€¢"; color: #f59e0b; position: absolute;
            bottom: -2px; left: 50%; transform: translateX(-50%); font-size: 16px;
        }

        /* --- ê³µí†µ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ --- */
        .modal-overlay {
            position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; background-color: rgba(0,0,0,0.4);
            display: flex; justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: #fefefe; border-radius: 8px; padding: 20px;
            border: 1px solid #888; width: 90%; max-width: 500px;
            max-height: 80vh; display: flex; flex-direction: column;
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #eee; padding-bottom: 10px;
        }
        .modal-header h4 { margin: 0; font-size: 18px; }
        .modal-close-btn {
            font-size: 28px; font-weight: bold; color: #aaa;
            cursor: pointer; background: none; border: none; padding: 0;
        }
        
        /* --- ê²€ìƒ‰ ëª¨ë‹¬ --- */
        #search-results-list { list-style: none; padding: 0; margin: 10px 0 0; overflow-y: auto; }
        .search-result-item {
            padding: 10px; border-bottom: 1px solid #f0f0f0; cursor: pointer;
        }
        .search-result-item:hover { background-color: #f4f4f9; }
        .search-result-item small { font-weight: 600; color: #007aff; display: block; }
        .search-result-item p { margin: 5px 0 0; color: #333; }
        
        /* --- ì„¤ì •/ë£¨í‹´ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ --- */
        .modal-body {
            padding-top: 15px;
            overflow-y: auto;
        }
        .modal-body label {
            display: block;
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 8px;
            color: #333;
        }
        .modal-body textarea {
            width: 100%;
            height: 150px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 8px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            margin-bottom: 15px;
        }
        .modal-body button {
            background-color: #007aff;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 15px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
            box-sizing: border-box;
        }
        .modal-body button.secondary {
            background-color: #f0f0f0;
            color: #333;
        }
        .modal-body button.danger {
            background-color: #ff3b30;
        }
        .modal-body button:hover {
            opacity: 0.8;
        }
        #import-data-label {
            display: inline-block;
            background-color: #5856d6;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            text-align: center;
            margin-top: 10px;
            width: 100%;
            box-sizing: border-box;
        }
        #import-data-label:hover { opacity: 0.8; }

        /* --- ë°˜ì‘í˜• (ëª¨ë°”ì¼) --- */
        @media (max-width: 768px) {
            /* 1. í—¤ë” ìˆ˜ì • (ê³µí†µ) */
            #date-header {
                flex-wrap: wrap; /* ë‚´ìš©ì´ ë„˜ì¹˜ë©´ ì¤„ë°”ê¿ˆ */
                height: auto;
                padding-bottom: 5px;
            }
            #date-controls-left {
                width: 100%; 
                justify-content: space-between; 
                margin-bottom: 8px;
            }
            #center-controls {
                flex: 1; 
                justify-content: flex-start;
            }
            #search-controls-right {
                flex: 1; 
                justify-content: flex-end;
            }
            #current-date {
                font-size: 16px; /* ëª¨ë°”ì¼ì—ì„œ ë‚ ì§œ í°íŠ¸ ì¡°ê¸ˆ ì¶•ì†Œ */
                min-width: auto;
            }
        }

        /* 2. ëª¨ë°”ì¼ ì„¸ë¡œ ëª¨ë“œ: ìƒí•˜ ë°°ì¹˜, í• ì¼ 8ì¤„ */
        @media (max-width: 768px) and (orientation: portrait) {
            .main-container {
                flex-direction: column;
            }
            .left-panel {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #e0e0e0;
                flex: 0 0 auto; /* ë‚´ìš©ë¬¼ í¬ê¸°ì— ë§ì¶¤ (ì•„ë˜ height ì°¸ê³ ) */
                height: auto; 
            }
            .right-panel {
                width: 100%;
                flex: 1; /* ë‚¨ì€ ê³µê°„ ëª¨ë‘ ì°¨ì§€ */
                min-height: 0;
            }
            /* ì„¸ë¡œ ëª¨ë“œì—ì„œ í• ì¼ ë¦¬ìŠ¤íŠ¸ ë†’ì´ ì¡°ì • (ì•½ 8ì¤„) */
            #todo-list {
                height: 240px;
                min-height: 240px; 
            }
            #todo-section {
                min-height: 0; /* ì»¨í…Œì´ë„ˆ ì œí•œ í•´ì œ */
            }
        }

        /* 3. ëª¨ë°”ì¼ ê°€ë¡œ ëª¨ë“œ (ë˜ëŠ” í™”ë©´ ë†’ì´ê°€ ë‚®ì„ ë•Œ): ì¢Œìš° ë°°ì¹˜ */
        @media (max-width: 900px) and (orientation: landscape) {
            .main-container {
                flex-direction: row;
            }
            /* â˜… Single Panel ViewëŠ” ê°€ë¡œëª¨ë“œì—ì„œë„ ìƒí•˜ ë°°ì¹˜ ìœ ì§€ (ëª¸ë¬´ê²Œ ê¸°ë¡ ë“±) */
            .main-container.single-panel-view {
                flex-direction: column;
            }

            .left-panel {
                width: 50%;
                height: 100%;
                border-right: 1px solid #e0e0e0;
                border-bottom: none;
                flex: 1;
            }
            .right-panel {
                width: 50%;
                height: 100%;
                flex: 1;
            }
            /* ë†’ì´ê°€ ë¶€ì¡±í•˜ë¯€ë¡œ min-height í•´ì œí•˜ì—¬ ìŠ¤í¬ë¡¤ ìœ ë„ */
            #todo-list {
                min-height: 0; 
                flex-grow: 1;
            }
        }
    </style>
<link rel="stylesheet" href="/index.css">
</head>
<body>

    <div class="app-container">
        
        <div id="date-header">
            <div id="date-controls-left">
                <button id="prev-day" aria-label="ì´ì „ ë‚ ì§œ">-</button>
                <span id="current-date"></span>
                <button id="next-day" aria-label="ë‹¤ìŒ ë‚ ì§œ">+</button>
                <button id="today-btn" aria-label="ì˜¤ëŠ˜ë¡œ ì´ë™">ğŸ¯</button>
                <button id="calendar-btn" aria-label="ë‹¬ë ¥ ì—´ê¸°">ğŸ“…</button>
                <button id="memo-btn" aria-label="ë©”ëª¨ ë³´ê¸°">ğŸ“</button>
            </div>
            <div id="center-controls">
                <button id="weight-btn" aria-label="ëª¸ë¬´ê²Œ">âš–ï¸</button>
                <button id="graph-btn" aria-label="ê·¸ë˜í”„">ğŸ“ˆ</button>
            </div>
            <div id="search-controls-right">
                <button id="playground-btn" aria-label="ë†€ì´í„°">ğŸŸï¸</button>
                <input type="search" id="search-input" placeholder="ê²€ìƒ‰...">
                <button id="search-btn" aria-label="ê²€ìƒ‰">ğŸ”</button>
                <button id="settings-btn" aria-label="ì„¤ì •">âš™ï¸</button>
            </div>
        </div>

        <div id="plan-container" class="main-container">
            <div class="left-panel">
                <div id="todo-section">
                    <div class="h3-wrapper">
                        <h3>ë¨¸ë¦¿ì† í•  ì¼</h3>
                        <button id="apply-routine-btn" aria-label="ë§¤ì¼ ë£¨í‹´ ì ìš©">ğŸ”„</button>
                    </div>
                    <div id="todo-input-section" class="input-section">
                        <input type="text" id="new-task-input" placeholder="ìƒˆë¡œìš´ í•  ì¼ ì…ë ¥...">
                        <button id="add-task-btn">+</button>
                    </div>
                    <ul id="todo-list"></ul>
                </div>
            </div>
            <div class="right-panel">
                <h3>ì‹œê°„í‘œ</h3>
                <div id="timeline-wrapper">
                    <div id="timeline"></div>
                </div>
            </div>
        </div>
        
        <div id="memo-container" class="main-container single-panel-view hidden">
            <textarea id="memo-textarea" placeholder="ì´ ë‚ ì˜ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
        </div>
        
        <div id="playground-container" class="main-container hidden">
            <div class="left-panel">
                <h3>ì¥ê¸° ëª©í‘œ ë¦¬ìŠ¤íŠ¸</h3>
                <div id="goal-input-section" class="input-section">
                    <input type="text" id="new-goal-input" placeholder="ìƒˆë¡œìš´ ëª©í‘œ ì…ë ¥...">
                    <button id="add-goal-btn">+</button>
                </div>
                <ul id="goal-list"></ul>
            </div>
            <div class="right-panel">
                <h3>ì§„ì²™ ìƒí™©</h3>
                <div id="goal-progress-view">
                    <div id="goal-progress-placeholder">
                        ì™¼ìª½ì—ì„œ ëª©í‘œë¥¼ ì„ íƒí•˜ì„¸ìš”.
                    </div>
                    <div id="goal-progress-content" class="hidden">
                        <textarea id="goal-progress-notes" placeholder="ì§„ì²™ ìƒí™©, ìƒê° ë“±ì„ ê¸°ë¡í•˜ì„¸ìš”. ì´ë¯¸ì§€ ë¶™ì—¬ë„£ê¸° (Ctrl+V) ê°€ëŠ¥"></textarea>
                        <div id="goal-image-controls">
                            <label for="goal-image-upload">ì´ë¯¸ì§€ ì¶”ê°€</label>
                            <input type="file" id="goal-image-upload" accept="image/*">
                            <button id="export-goal-pdf-btn">PDFë¡œ ë‚´ë³´ë‚´ê¸°</button>
                        </div>
                        <div id="goal-progress-images">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="weight-container" class="main-container single-panel-view hidden">
            <div class="h3-wrapper">
                <h3>ëª¸ë¬´ê²Œ ê¸°ë¡</h3>
                <label for="import-weight-file" id="import-weight-label">ê³¼ê±° ê¸°ë¡ (txt) ë¶ˆëŸ¬ì˜¤ê¸°</label>
                <input type="file" id="import-weight-file" accept=".txt" style="display: none;">
            </div>
            <div class="input-section">
                <input type="number" id="new-weight-input" placeholder="ì˜¤ëŠ˜ ëª¸ë¬´ê²Œ (kg)" step="0.1">
                <input type="text" id="new-alcohol-input" placeholder="ìŒì£¼ëŸ‰" style="flex-grow:0.5;">
                <button id="add-weight-btn">+</button>
            </div>
            
            <div id="weight-sheet-wrapper">
                <table class="sheet-table">
                    <thead>
                        <tr>
                            <th style="width: 25%;">ë‚ ì§œ</th>
                            <th style="width: 30%;">ëª¸ë¬´ê²Œ (kg)</th>
                            <th style="width: 30%;">ìŒì£¼ëŸ‰</th>
                            <th style="width: 15%;">ì‚­ì œ</th>
                        </tr>
                    </thead>
                    <tbody id="weight-table-body">
                        <!-- JSê°€ ì±„ì›€ -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <div id="graph-container" class="main-container single-panel-view hidden">
            <h3 style="text-align: center;">ëª¸ë¬´ê²Œ ê·¸ë˜í”„ (<span id="graph-range-label">1ê°œì›”</span>)</h3>
            <div id="graph-chart-wrapper">
                <canvas id="weight-chart"></canvas>
            </div>
        </div>

    </div>

    <div id="search-results-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h4>ê²€ìƒ‰ ê²°ê³¼</h4>
                <span id="close-search-modal" class="modal-close-btn" aria-label="ë‹«ê¸°">&times;</span>
            </div>
            <ul id="search-results-list"></ul>
        </div>
    </div>
    
    <div id="settings-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h4>ì„¤ì •</h4>
                <button id="close-settings-modal" class="modal-close-btn" aria-label="ë‹«ê¸°">&times;</button>
            </div>
            <div class="modal-body">
                <button id="settings-routine-btn">ë§¤ì¼ ë£¨í‹´ ì„¤ì •</button>
                <hr style="border: 0; border-top: 1px solid #eee; margin: 15px 0;">
                <button id="settings-backup-btn">ì „ì²´ ë°ì´í„° ë°±ì—…</button>
                <label for="import-file-input" id="import-data-label">ì „ì²´ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</label>
                <input type="file" id="import-file-input" accept=".json" style="display: none;">
                <hr style="border: 0; border-top: 1px solid #eee; margin: 15px 0;">
                <button id="settings-delete-all-btn" class="danger">ì „ì²´ ë°ì´í„° ì‚­ì œ</button>
            </div>
        </div>
    </div>
    
    <div id="routine-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h4>ë§¤ì¼ ë£¨í‹´ ì„¤ì •</h4>
                <button id="close-routine-modal" class="modal-close-btn" aria-label="ë‹«ê¸°">&times;</button>
            </div>
            <div class="modal-body">
                <label for="routine-input">ë§¤ì¼ ë°˜ë³µí•  í•  ì¼ (í•œ ì¤„ì— í•˜ë‚˜ì”©)</label>
                <textarea id="routine-input" placeholder="ì˜ˆ: ë¬¼ 1L ë§ˆì‹œê¸°"></textarea>
                <button id="save-routine-btn">ë£¨í‹´ ì €ì¥</button>
            </div>
        </div>
    </div>


    <script>
        // (JS ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ í™•ì¸)
        window.jsPDF = window.jspdf.jsPDF;

        // --- HTML ìš”ì†Œ ---
        const newTaskInput = document.getElementById('new-task-input');
        const addTaskBtn = document.getElementById('add-task-btn');
        const todoList = document.getElementById('todo-list');
        const timeline = document.getElementById('timeline');
        const dateDisplay = document.getElementById('current-date');
        const prevDayBtn = document.getElementById('prev-day');
        const nextDayBtn = document.getElementById('next-day');
        const calendarBtn = document.getElementById('calendar-btn');
        const planContainer = document.getElementById('plan-container');
        const memoBtn = document.getElementById('memo-btn');
        const memoContainer = document.getElementById('memo-container');
        const memoTextarea = document.getElementById('memo-textarea');
        const searchInput = document.getElementById('search-input');
        const searchBtn = document.getElementById('search-btn');
        const searchResultsModal = document.getElementById('search-results-modal');
        const closeSearchModalBtn = document.getElementById('close-search-modal');
        const searchResultsList = document.getElementById('search-results-list');
        const playgroundBtn = document.getElementById('playground-btn');
        const playgroundContainer = document.getElementById('playground-container');
        const newGoalInput = document.getElementById('new-goal-input');
        const addGoalBtn = document.getElementById('add-goal-btn');
        const goalList = document.getElementById('goal-list');
        const goalProgressView = document.getElementById('goal-progress-view');
        const goalProgressPlaceholder = document.getElementById('goal-progress-placeholder');
        const goalProgressContent = document.getElementById('goal-progress-content');
        const goalProgressNotes = document.getElementById('goal-progress-notes');
        const goalImageUpload = document.getElementById('goal-image-upload');
        const goalProgressImages = document.getElementById('goal-progress-images');
        const exportGoalPdfBtn = document.getElementById('export-goal-pdf-btn');
        const weightBtn = document.getElementById('weight-btn');
        const graphBtn = document.getElementById('graph-btn');
        const weightContainer = document.getElementById('weight-container');
        const newWeightInput = document.getElementById('new-weight-input');
        const newAlcoholInput = document.getElementById('new-alcohol-input'); 
        const addWeightBtn = document.getElementById('add-weight-btn');
        const weightTableBody = document.getElementById('weight-table-body'); 
        
        const graphContainer = document.getElementById('graph-container');
        const graphRangeLabel = document.getElementById('graph-range-label');
        const weightChartCanvas = document.getElementById('weight-chart');
        
        const todayBtn = document.getElementById('today-btn');
        const settingsBtn = document.getElementById('settings-btn');
        const settingsModal = document.getElementById('settings-modal');
        const closeSettingsModalBtn = document.getElementById('close-settings-modal');
        const settingsRoutineBtn = document.getElementById('settings-routine-btn');
        const settingsBackupBtn = document.getElementById('settings-backup-btn');
        const importDataLabel = document.getElementById('import-data-label');
        const importFileInput = document.getElementById('import-file-input');
        const settingsDeleteAllBtn = document.getElementById('settings-delete-all-btn');
        const routineModal = document.getElementById('routine-modal');
        const closeRoutineModalBtn = document.getElementById('close-routine-modal');
        const routineInput = document.getElementById('routine-input');
        const saveRoutineBtn = document.getElementById('save-routine-btn');
        const applyRoutineBtn = document.getElementById('apply-routine-btn');
        const importWeightFile = document.getElementById('import-weight-file');

        // --- ìƒíƒœ ë³€ìˆ˜ ---
        let draggedTaskItem = null;
        let currentDate = new Date();
        let calendarInstance = null;
        let playgroundData = { goals: [] };
        let selectedGoalId = null;
        const PLAYGROUND_KEY = 'playgroundData';
        let weightData = [];
        const WEIGHT_KEY = 'weightData';
        let chartRangeMode = 0;
        let currentChartInstance = null;
        let currentView = 'plan-container';
        const ROUTINE_KEY = 'dailyRoutines';

        // --- ë·° ì „í™˜ ---
        function showView(viewToShow) {
            planContainer.classList.add('hidden');
            memoContainer.classList.add('hidden');
            playgroundContainer.classList.add('hidden');
            weightContainer.classList.add('hidden');
            graphContainer.classList.add('hidden');
            document.getElementById(viewToShow).classList.remove('hidden');
            currentView = viewToShow;
            memoBtn.textContent = 'ğŸ“';
            playgroundBtn.textContent = 'ğŸŸï¸';
            weightBtn.style.color = '#007aff';
            graphBtn.style.color = '#007aff';
            if (viewToShow === 'memo-container') memoBtn.textContent = 'ğŸ“‹';
            if (viewToShow === 'playground-container') playgroundBtn.textContent = 'ğŸ“‹';
            if (viewToShow === 'weight-container') {
                weightBtn.style.color = '#FF9500';
                newWeightInput.placeholder = `${getDateKey(currentDate).replace(/-/g, '.')} ëª¸ë¬´ê²Œ (kg)`;
            }
            if (viewToShow === 'graph-container') graphBtn.style.color = '#FF9500';
            
            applyRoutineBtn.style.display = (viewToShow === 'plan-container') ? 'block' : 'none';
        }
        memoBtn.addEventListener('click', () => {
            if (memoContainer.classList.contains('hidden')) showView('memo-container');
            else showView('plan-container');
        });
        playgroundBtn.addEventListener('click', () => {
            if (playgroundContainer.classList.contains('hidden')) showView('playground-container');
            else showView('plan-container');
        });
        weightBtn.addEventListener('click', () => {
            if (weightContainer.classList.contains('hidden')) showView('weight-container');
            else showView('plan-container');
        });
        
        graphBtn.addEventListener('click', () => {
            if (graphContainer.classList.contains('hidden')) {
                chartRangeMode = 0;
            } else {
                chartRangeMode = (chartRangeMode + 1) % 6;
            }
            renderWeightChart();
            showView('graph-container');
        });
        
        // --- ê¸°ë³¸ ê¸°ëŠ¥ ---
        todayBtn.addEventListener('click', () => changeDate(new Date()));
        settingsBtn.addEventListener('click', () => settingsModal.classList.remove('hidden'));
        closeSettingsModalBtn.addEventListener('click', () => settingsModal.classList.add('hidden'));
        settingsRoutineBtn.addEventListener('click', () => {
            const currentRoutines = JSON.parse(localStorage.getItem(ROUTINE_KEY) || '[]');
            routineInput.value = currentRoutines.join('\n');
            routineModal.classList.remove('hidden');
        });
        closeRoutineModalBtn.addEventListener('click', () => routineModal.classList.add('hidden'));
        
        saveRoutineBtn.addEventListener('click', () => {
            const newRoutines = routineInput.value.split('\n').map(r => r.trim()).filter(r => r.length > 0);
            localStorage.setItem(ROUTINE_KEY, JSON.stringify(newRoutines));
            routineModal.classList.add('hidden');
            settingsModal.classList.add('hidden');
            alert("ë£¨í‹´ í…œí”Œë¦¿ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. 'ë¨¸ë¦¿ì† í•  ì¼'ì˜ ğŸ”„ ë²„íŠ¼ìœ¼ë¡œ ì ìš©/ì‚­ì œí•˜ì„¸ìš”.");
        });
        
        applyRoutineBtn.addEventListener('click', () => {
            const currentRoutines = JSON.parse(localStorage.getItem(ROUTINE_KEY) || '[]');
            const routineItemsInList = todoList.querySelectorAll('.routine-item');

            if (routineItemsInList.length > 0) {
                if (!confirm("í˜„ì¬ ë‚ ì§œì˜ ë£¨í‹´ì„ ëª©ë¡ì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
                routineItemsInList.forEach(item => {
                    item.remove();
                });
            } else {
                if (currentRoutines.length === 0) {
                    alert("ì„¤ì •(âš™ï¸)ì—ì„œ 'ë§¤ì¼ ë£¨í‹´'ì„ ë¨¼ì € ë“±ë¡í•´ì£¼ì„¸ìš”.");
                    return;
                }
                const existingTasks = new Set(
                    Array.from(todoList.children).map(item => item.querySelector('span').textContent)
                );
                let addedCount = 0;
                currentRoutines.slice().reverse().forEach(routineText => {
                    if (!existingTasks.has(routineText)) {
                        addNewTask(routineText, false, false, true, true); 
                        addedCount++;
                    }
                });
                if (addedCount === 0) {
                    alert("ëª¨ë“  ë£¨í‹´ì´ ì´ë¯¸ ëª©ë¡ì— ìˆìŠµë‹ˆë‹¤.");
                }
            }
            savePlanData(); 
            checkRoutineBtnState(); 
        });

        settingsBackupBtn.addEventListener('click', () => {
            const backupData = {
                plans: {},
                playground: JSON.parse(localStorage.getItem(PLAYGROUND_KEY) || '{}'),
                weight: JSON.parse(localStorage.getItem(WEIGHT_KEY) || '[]'),
                routines: JSON.parse(localStorage.getItem(ROUTINE_KEY) || '[]')
            };
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('plan_')) {
                    backupData.plans[key] = JSON.parse(localStorage.getItem(key));
                }
            }
            const dataStr = JSON.stringify(backupData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `plan_backup_${getDateKey(new Date())}.json`;
            a.click();
            URL.revokeObjectURL(url);
            settingsModal.classList.add('hidden');
        });
        importDataLabel.addEventListener('click', () => importFileInput.click());
        importFileInput.addEventListener('change', (e) => {
            if (!e.target.files.length) return;
            if (!confirm("ê²½ê³ : í˜„ì¬ ëª¨ë“  ë°ì´í„°ë¥¼ ë®ì–´ì“°ê³  ë³µêµ¬í•©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const parsedData = JSON.parse(event.target.result);
                    localStorage.clear();
                    localStorage.setItem(PLAYGROUND_KEY, JSON.stringify(parsedData.playground || {}));
                    localStorage.setItem(WEIGHT_KEY, JSON.stringify(parsedData.weight || []));
                    localStorage.setItem(ROUTINE_KEY, JSON.stringify(parsedData.routines || []));
                    if (parsedData.plans) {
                        for (const key in parsedData.plans) {
                            localStorage.setItem(key, JSON.stringify(parsedData.plans[key]));
                        }
                    }
                    alert("ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤. ì•±ì„ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.");
                    location.reload();
                } catch (err) {
                    alert("ì˜¤ë¥˜: ì˜ëª»ëœ ë°±ì—… íŒŒì¼ì…ë‹ˆë‹¤.");
                }
            };
            reader.readAsText(file);
            settingsModal.classList.add('hidden');
        });
        settingsDeleteAllBtn.addEventListener('click', () => {
            if (!confirm("ê²½ê³ : ì´ ì•±ì˜ ëª¨ë“  ë°ì´í„°(ê³„íš, ëª©í‘œ, ëª¸ë¬´ê²Œ)ê°€ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë©ë‹ˆë‹¤. ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            localStorage.clear();
            alert("ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. ì•±ì„ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.");
            location.reload();
        });


        function getDateKey(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        function getStorageKey(date) { return `plan_${getDateKey(date)}`; }
        
        function savePlanData() {
            const key = getStorageKey(currentDate);
            const todos = Array.from(todoList.children).map(item => ({
                text: item.querySelector('span').textContent,
                checked: item.querySelector('input[type="checkbox"]').checked,
                isImportant: item.classList.contains('is-important'),
                isRoutine: item.classList.contains('routine-item')
            }));
            const timelineTasks = {};
            timeline.querySelectorAll('.time-slot').forEach(slot => {
                const time = slot.dataset.time;
                const tasks = Array.from(slot.querySelectorAll('.dropped-task')).map(task => ({
                    text: task.childNodes[0].nodeValue,
                    isImportant: task.classList.contains('is-important')
                }));
                if (tasks.length > 0) timelineTasks[time] = tasks;
            });
            const memoText = memoTextarea.value;
            // selectedTasks removed
            const data = { todos, timelineTasks, memoText };
            
            if (data.todos.length === 0 && Object.keys(timelineTasks).length === 0 && memoText.trim() === '') {
                localStorage.removeItem(key);
            } else {
                localStorage.setItem(key, JSON.stringify(data));
            }
            
            if (calendarInstance) { calendarInstance.redraw(); }
        }
        
        function loadPlanData() {
            const key = getStorageKey(currentDate);
            const data = JSON.parse(localStorage.getItem(key));
            
            todoList.innerHTML = '';
            timeline.querySelectorAll('.dropped-task').forEach(task => task.remove());
            memoTextarea.value = '';
            
            let finalTodoList = [];
            
            if (data) {
                finalTodoList = data.todos || [];
            }

            finalTodoList.forEach(t => {
                addNewTask(t.text, t.checked, t.isImportant, t.isRoutine);
            });
            
            if (data) {
                // selectedTasks load removed
                if (data.timelineTasks) {
                    for (const [time, tasks] of Object.entries(data.timelineTasks)) {
                        const timeSlot = timeline.querySelector(`[data-time="${time}"]`);
                        if (timeSlot) {
                            tasks.forEach(taskData => {
                                createDroppedTaskElement(timeSlot, taskData.text, taskData.isImportant, false); 
                            });
                        }
                    }
                }
                if (data.memoText) { memoTextarea.value = data.memoText; }
            }
            
            checkRoutineBtnState();
        }
        
        function checkRoutineBtnState() {
            const routineItemsInList = todoList.querySelectorAll('.routine-item');
            if (routineItemsInList.length > 0) {
                applyRoutineBtn.classList.add('active'); 
                applyRoutineBtn.title = "ë§¤ì¼ ë£¨í‹´ ì‚­ì œ";
            } else {
                applyRoutineBtn.classList.remove('active');
                applyRoutineBtn.title = "ë§¤ì¼ ë£¨í‹´ ì ìš©";
            }
        }

        memoTextarea.addEventListener('input', savePlanData);

        searchBtn.addEventListener('click', performSearch);
        searchInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') performSearch(); });
        closeSearchModalBtn.addEventListener('click', () => { searchResultsModal.classList.add('hidden'); });
        function performSearch() {
            const query = searchInput.value.trim().toLowerCase();
            if (query === '') return;
            searchResultsList.innerHTML = '';
            const results = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('plan_')) {
                    const data = JSON.parse(localStorage.getItem(key));
                    const dateStr = key.substring(5);
                    if (data.memoText && data.memoText.toLowerCase().includes(query)) {
                        results.push({ date: dateStr, match: 'ë©”ëª¨: ' + data.memoText.substring(0, 80) + '...' });
                    }
                    if (data.todos) {
                        data.todos.forEach(todo => {
                            if (todo.text.toLowerCase().includes(query)) {
                                results.push({ date: dateStr, match: 'í• ì¼: ' + todo.text });
                            }
                        });
                    }
                }
            }
            displaySearchResults(results, query);
        }
        function displaySearchResults(results, query) {
            if (results.length === 0) {
                searchResultsList.innerHTML = `<li style="padding: 10px; text-align: center;">'${query}'ì— ëŒ€í•œ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</li>`;
            } else {
                results.forEach(result => {
                    const li = document.createElement('li');
                    li.classList.add('search-result-item');
                    li.innerHTML = `<small>${result.date.replace(/-/g, '.')}</small><p>${result.match}</p>`;
                    li.addEventListener('click', () => {
                        const newDate = new Date(result.date + 'T00:00:00');
                        changeDate(newDate);
                        searchResultsModal.classList.add('hidden');
                    });
                    searchResultsList.appendChild(li);
                });
            }
            searchResultsModal.classList.remove('hidden');
        }

        // ì¼ìš´(æ—¥é‹) ê³„ì‚° í•¨ìˆ˜
        function getDayun(date) {
            // ì‹­ê°„(åå¹²): ç”²ä¹™ä¸™ä¸æˆŠå·±åºšè¾›å£¬ç™¸
            const tenStems = ['ç”²', 'ä¹™', 'ä¸™', 'ä¸', 'æˆŠ', 'å·±', 'åºš', 'è¾›', 'å£¬', 'ç™¸'];
            // ì‹­ì´ì§€(åäºŒæ”¯): å­ä¸‘å¯…å¯è¾°å·³åˆæœªç”³é…‰æˆŒäº¥
            const twelveBranches = ['å­', 'ä¸‘', 'å¯…', 'å¯', 'è¾°', 'å·³', 'åˆ', 'æœª', 'ç”³', 'é…‰', 'æˆŒ', 'äº¥'];
            
            // ê¸°ì¤€ì¼: 2026ë…„ 1ì›” 17ì¼ = ì‹ ë¬˜ì¼ (è¾›å¯æ—¥)
            const baseDate = new Date(2026, 0, 17); // ì›”ì€ 0-based
            const baseStemIndex = 7; // ì‹ (è¾›) = 7
            const baseBranchIndex = 3; // ë¬˜(å¯) = 3
            
            // ë‚ ì§œ ì°¨ì´ ê³„ì‚° (ë°€ë¦¬ì´ˆë¥¼ ì¼ ë‹¨ìœ„ë¡œ ë³€í™˜)
            const diffTime = date.getTime() - baseDate.getTime();
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            // 60ê°‘ì ìˆœí™˜ ê³„ì‚°
            const stemIndex = (baseStemIndex + diffDays + 1000) % 10; // ìŒìˆ˜ ë°©ì§€
            const branchIndex = (baseBranchIndex + diffDays + 1200) % 12; // ìŒìˆ˜ ë°©ì§€
            
            return {
                stem: tenStems[stemIndex],
                branch: twelveBranches[branchIndex],
                stemIndex: stemIndex,
                branchIndex: branchIndex
            };
        }
        
        // ì‹­ê°„(ì²œê°„)ì˜ ì˜¤í–‰ ìƒ‰ìƒ ë°˜í™˜
        function getStemColor(stemIndex) {
            // ç”²(0), ä¹™(1) - æœ¨(ëª©) - ì´ˆë¡
            if (stemIndex === 0 || stemIndex === 1) return '#2e7d32';
            // ä¸™(2), ä¸(3) - ç«(í™”) - ë¹¨ê°•
            if (stemIndex === 2 || stemIndex === 3) return '#d32f2f';
            // æˆŠ(4), å·±(5) - åœŸ(í† ) - ë…¸ë‘
            if (stemIndex === 4 || stemIndex === 5) return '#ffc107';
            // åºš(6), è¾›(7) - é‡‘(ê¸ˆ) - ì—°í•œ íšŒìƒ‰
            if (stemIndex === 6 || stemIndex === 7) return '#bdbdbd';
            // å£¬(8), ç™¸(9) - æ°´(ìˆ˜) - ê²€ì •
            if (stemIndex === 8 || stemIndex === 9) return '#000000';
            return '#333'; // ê¸°ë³¸ê°’
        }
        
        // ì‹­ì´ì§€(ì§€ì§€)ì˜ ì˜¤í–‰ ìƒ‰ìƒ ë°˜í™˜
        function getBranchColor(branchIndex) {
            // å­(0), äº¥(11) - æ°´(ìˆ˜) - ê²€ì •
            if (branchIndex === 0 || branchIndex === 11) return '#000000';
            // å¯…(2), å¯(3) - æœ¨(ëª©) - ì´ˆë¡
            if (branchIndex === 2 || branchIndex === 3) return '#2e7d32';
            // å·³(5), åˆ(6) - ç«(í™”) - ë¹¨ê°•
            if (branchIndex === 5 || branchIndex === 6) return '#d32f2f';
            // è¾°(4), æˆŒ(10), ä¸‘(1), æœª(7) - åœŸ(í† ) - ë…¸ë‘
            if (branchIndex === 4 || branchIndex === 10 || branchIndex === 1 || branchIndex === 7) return '#ffc107';
            // ç”³(8), é…‰(9) - é‡‘(ê¸ˆ) - ì—°í•œ íšŒìƒ‰
            if (branchIndex === 8 || branchIndex === 9) return '#bdbdbd';
            return '#333'; // ê¸°ë³¸ê°’
        }
        
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const week = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '][date.getDay()];
            const dayun = getDayun(date);
            const stemColor = getStemColor(dayun.stemIndex);
            const branchColor = getBranchColor(dayun.branchIndex);
            return `${year}.${month}.${day} (${week}) <span style="color: ${stemColor}; font-weight: 600;">${dayun.stem}</span><span style="color: ${branchColor}; font-weight: 600;">${dayun.branch}</span>`;
        }
        function updateDateDisplay() {
            dateDisplay.innerHTML = formatDate(currentDate);
            if (calendarInstance) { calendarInstance.setDate(currentDate, false); }
        }
        function refreshCurrentViewData() {
            showView(currentView);
            
            switch (currentView) {
                case 'plan-container':
                case 'memo-container':
                    loadPlanData();
                    break;
                case 'weight-container':
                    loadWeightData();
                    break;
                case 'graph-container':
                    renderWeightChart();
                    break;
                case 'playground-container':
                    break;
            }
        }
        function changeDate(newDate) {
            currentDate = newDate;
            updateDateDisplay();
            refreshCurrentViewData();
        }
        prevDayBtn.addEventListener('click', () => {
            const newDate = new Date(currentDate);
            newDate.setDate(newDate.getDate() - 1);
            changeDate(newDate);
        });
        nextDayBtn.addEventListener('click', () => {
            const newDate = new Date(currentDate);
            newDate.setDate(newDate.getDate() + 1);
            changeDate(newDate);
        });

        function createTimeline() {
            timeline.innerHTML = ''; 
            for (let hour = 6; hour <= 22; hour++) {
                const timeSlot = document.createElement('div');
                timeSlot.classList.add('time-slot');
                timeSlot.dataset.time = `${hour}:00`; 
                const timeLabel = document.createElement('span');
                timeLabel.classList.add('time-label');
                timeLabel.textContent = `${hour}:00`;
                timeSlot.appendChild(timeLabel);
                addDropListeners(timeSlot);
                timeline.appendChild(timeSlot);
            }
        }
        
        function deleteTaskGlobally(taskText) {
            const originalTaskItem = Array.from(todoList.children).find(
                item => item.querySelector('span').textContent === taskText
            );
            
            if (originalTaskItem && originalTaskItem.classList.contains('routine-item')) {
                alert("ë§¤ì¼ ë£¨í‹´ì€ 'ì„¤ì • > ë§¤ì¼ ë£¨í‹´ ì„¤ì •'ì—ì„œ ìˆ˜ì •í•˜ê±°ë‚˜, ğŸ”„ ë²„íŠ¼ìœ¼ë¡œ í˜„ì¬ ë‚ ì§œì—ì„œë§Œ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                return;
            }

            const timelineTasks = timeline.querySelectorAll('.dropped-task');
            timelineTasks.forEach(task => {
                if (task.childNodes[0].nodeValue === taskText) {
                    task.remove();
                }
            });
            
            if (originalTaskItem) {
                originalTaskItem.remove();
            }
            savePlanData();
        }

        addTaskBtn.addEventListener('click', () => addNewTask(null, false, false, false, true)); 
        newTaskInput.addEventListener('keypress', function(e) { 
            if (e.key === 'Enter') addNewTask(null, false, false, false, true); 
        });
        
        function addNewTask(taskText = null, isChecked = false, isImportant = false, isRoutine = false, isNewEntry = false) {
            if (taskText === null) {
                taskText = newTaskInput.value.trim();
                if (taskText === '') return;
                
                const currentRoutines = JSON.parse(localStorage.getItem(ROUTINE_KEY) || '[]');
                if (currentRoutines.includes(taskText) || Array.from(todoList.children).some(item => item.querySelector('span').textContent === taskText)) {
                    alert("ì´ë¯¸ ëª©ë¡ì— ìˆëŠ” í•­ëª©ì…ë‹ˆë‹¤.");
                    newTaskInput.value = '';
                    return;
                }
                newTaskInput.value = '';
            }
            
            const taskItem = document.createElement('li');
            taskItem.classList.add('task-item');
            if (isRoutine) taskItem.classList.add('routine-item');
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            const taskSpan = document.createElement('span');
            taskSpan.textContent = taskText;
            taskSpan.contentEditable = "true";
            taskSpan.addEventListener('blur', () => {
                savePlanData();
            });
            taskSpan.addEventListener('keypress', (e) => {
                 if (e.key === 'Enter') { e.preventDefault(); taskSpan.blur(); }
            });

            // â˜… 1. í´ë¦­ ì‹œ ì¤‘ìš” í‘œì‹œ(ë¹¨ê°• êµµê²Œ) í† ê¸€ ë³µì›
            taskSpan.addEventListener('click', (e) => {
                 taskItem.classList.toggle('is-important');
                 savePlanData();
            });

            const deleteBtn = document.createElement('button');
            deleteBtn.classList.add('delete-btn');
            deleteBtn.innerHTML = '&times;';
            deleteBtn.setAttribute('aria-label', 'ì‚­ì œ');
            
            taskItem.appendChild(checkbox);
            taskItem.appendChild(taskSpan);
            taskItem.appendChild(deleteBtn);
            
            taskItem.draggable = true;
            taskItem.addEventListener('dragstart', (e) => {
                draggedTaskItem = taskItem;
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', taskText);
                setTimeout(() => { taskItem.style.opacity = '0.5'; }, 0);
            });
            taskItem.addEventListener('dragend', () => {
                if (draggedTaskItem) { draggedTaskItem.style.opacity = '1'; }
                draggedTaskItem = null;
            });

            if (isRoutine) {
                deleteBtn.style.display = 'none'; 
            } else {
                deleteBtn.addEventListener('click', () => {
                    deleteTaskGlobally(taskText);
                });
            }

            checkbox.addEventListener('change', () => {
                taskItem.classList.toggle('completed', checkbox.checked);
                savePlanData(); 
            });

            if (isImportant) { taskItem.classList.add('is-important'); }
            if (isChecked) {
                checkbox.checked = true;
                taskItem.classList.add('completed');
            }
            
            if (isNewEntry && isRoutine) {
                todoList.prepend(taskItem);
            } else {
                todoList.appendChild(taskItem);
            }

            if (isNewEntry) { savePlanData(); }
        }

        function createDroppedTaskElement(timeSlot, text, isImportant, isRoutine) {
            const droppedTask = document.createElement('div');
            droppedTask.classList.add('dropped-task');
            droppedTask.classList.toggle('is-important', isImportant);
            droppedTask.classList.toggle('is-general', !isImportant);
            
            droppedTask.appendChild(document.createTextNode(text));

            droppedTask.draggable = true;
            droppedTask.addEventListener('dragstart', (e) => {
                draggedTaskItem = droppedTask;
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', text);
                setTimeout(() => { droppedTask.style.opacity = '0.5'; }, 0);
            });
            droppedTask.addEventListener('dragend', () => {
                if (draggedTaskItem) { droppedTask.style.opacity = '1'; }
                draggedTaskItem = null;
            });
            
            droppedTask.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation(); 
                timeSlot.classList.add('drag-over');
            });
            droppedTask.addEventListener('dragleave', (e) => {
                e.stopPropagation();
                timeSlot.classList.remove('drag-over');
            });
            
            const deleteBtn = document.createElement('button');
            deleteBtn.classList.add('timeline-delete-btn');
            deleteBtn.innerHTML = '&times;';
            deleteBtn.setAttribute('aria-label', 'ì‚­ì œ');
            
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                deleteTaskGlobally(text);
            });

            droppedTask.appendChild(deleteBtn);
            timeSlot.appendChild(droppedTask);
        }
        function addDropListeners(timeSlot) {
            timeSlot.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                timeSlot.classList.add('drag-over');
            });
            timeSlot.addEventListener('dragleave', () => {
                timeSlot.classList.remove('drag-over');
            });
            timeSlot.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                const targetSlot = e.target.closest('.time-slot');
                if (!targetSlot) return; 
                
                targetSlot.classList.remove('drag-over');
                if (!draggedTaskItem) return;

                const taskText = draggedTaskItem.textContent.replace('Ã—', '').trim();

                if (draggedTaskItem.classList.contains('dropped-task')) {
                    draggedTaskItem.style.opacity = '1';
                    targetSlot.appendChild(draggedTaskItem);
                }
                else if (draggedTaskItem.classList.contains('task-item')) {
                    let isImportant = false;
                    let isRoutine = false; 
                    let originalTaskItem = null;
                    
                    if (draggedTaskItem.classList.contains('task-item')) {
                        originalTaskItem = draggedTaskItem;
                    } else { 
                        originalTaskItem = Array.from(todoList.children).find(
                            item => item.querySelector('span').textContent === taskText
                        );
                    }
                    
                    if (originalTaskItem) {
                        isImportant = originalTaskItem.classList.contains('is-important');
                        isRoutine = originalTaskItem.classList.contains('routine-item');
                        
                        originalTaskItem.classList.add('completed');
                        const checkbox = originalTaskItem.querySelector('input[type="checkbox"]');
                        if (checkbox) checkbox.checked = true;
                    }

                    createDroppedTaskElement(targetSlot, taskText, isImportant, isRoutine);
                }
                draggedTaskItem = null;
                savePlanData();
            });
        }

        // --- ë†€ì´í„°, ëª¸ë¬´ê²Œ ë“± ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€ ---
        function savePlaygroundData() {
            if (selectedGoalId) {
                const goal = playgroundData.goals.find(g => g.id === selectedGoalId);
                if (goal) { goal.progressNotes = goalProgressNotes.value; }
            }
            localStorage.setItem(PLAYGROUND_KEY, JSON.stringify(playgroundData));
        }
        function loadPlaygroundData() {
            const data = JSON.parse(localStorage.getItem(PLAYGROUND_KEY));
            if (data) { playgroundData = data; }
            renderGoalList();
            showGoalProgress(null);
        }
        function renderGoalList() {
            goalList.innerHTML = '';
            playgroundData.goals.forEach(goal => {
                const li = document.createElement('li');
                li.classList.add('goal-item');
                li.dataset.id = goal.id;
                li.classList.toggle('completed', goal.checked);
                li.classList.toggle('selected', goal.id === selectedGoalId);
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = goal.checked;
                checkbox.addEventListener('change', () => {
                    goal.checked = checkbox.checked;
                    li.classList.toggle('completed', goal.checked);
                    savePlaygroundData();
                });
                const span = document.createElement('span');
                span.textContent = goal.text;
                span.contentEditable = "true";
                span.addEventListener('blur', () => {
                    goal.text = span.textContent;
                    savePlaygroundData();
                });
                span.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') { e.preventDefault(); span.blur(); }
                });
                const deleteBtn = document.createElement('button');
                deleteBtn.classList.add('delete-btn');
                deleteBtn.innerHTML = '&times;';
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    playgroundData.goals = playgroundData.goals.filter(g => g.id !== goal.id);
                    savePlaygroundData();
                    renderGoalList();
                    if (selectedGoalId === goal.id) { showGoalProgress(null); }
                });
                li.appendChild(checkbox);
                li.appendChild(span);
                li.appendChild(deleteBtn);
                li.addEventListener('click', () => { showGoalProgress(goal.id); });
                goalList.appendChild(li);
            });
        }
        function addNewGoal() {
            const text = newGoalInput.value.trim();
            if (text === '') return;
            const newGoal = {
                id: crypto.randomUUID(), text: text, checked: false, progressNotes: "",
                images: []
            };
            playgroundData.goals.push(newGoal);
            savePlaygroundData();
            renderGoalList();
            newGoalInput.value = '';
        }
        function showGoalProgress(goalId) {
            if (selectedGoalId) {
                const oldGoal = playgroundData.goals.find(g => g.id === selectedGoalId);
                if (oldGoal) { oldGoal.progressNotes = goalProgressNotes.value; }
                const oldLi = goalList.querySelector(`[data-id="${selectedGoalId}"]`);
                if (oldLi) oldLi.classList.remove('selected');
            }
            selectedGoalId = goalId;
            if (goalId === null) {
                goalProgressPlaceholder.classList.remove('hidden');
                goalProgressContent.classList.add('hidden');
            } else {
                const goal = playgroundData.goals.find(g => g.id === goalId);
                const li = goalList.querySelector(`[data-id="${goalId}"]`);
                if (li) li.classList.add('selected');
                goalProgressPlaceholder.classList.add('hidden');
                goalProgressContent.classList.remove('hidden');
                goalProgressNotes.value = goal.progressNotes;
                renderGoalImages();
            }
        }
        goalProgressNotes.addEventListener('input', savePlaygroundData);
        goalProgressNotes.addEventListener('paste', (e) => {
            if (!selectedGoalId) return;
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            for (const item of items) {
                if (item.type.indexOf('image') === 0) {
                    const file = item.getAsFile();
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        addImageToGoal(event.target.result);
                    };
                    reader.readAsDataURL(file);
                }
            }
        });
        function addImageToGoal(base64) {
            if (!selectedGoalId) return;
            const goal = playgroundData.goals.find(g => g.id === selectedGoalId);
            goal.images.push({ src: base64, size: '100' });
            savePlaygroundData();
            renderGoalImages();
        }
        function renderGoalImages() {
            goalProgressImages.innerHTML = '';
            if (!selectedGoalId) return;
            const goal = playgroundData.goals.find(g => g.id === selectedGoalId);
            goal.images.forEach((imgData, index) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'image-wrapper';
                const img = document.createElement('img');
                img.src = imgData.src;
                img.dataset.size = imgData.size;
                img.title = "í´ë¦­í•˜ì—¬ í¬ê¸° ì¡°ì ˆ (100% > 75% > 50%)";
                img.addEventListener('click', () => { cycleImageSize(index); });
                const controls = document.createElement('div');
                controls.className = 'image-controls';
                const upBtn = document.createElement('button');
                upBtn.innerHTML = 'â†‘';
                upBtn.title = 'ìœ„ë¡œ';
                if (index === 0) upBtn.disabled = true;
                upBtn.addEventListener('click', () => { moveImage(index, index - 1); });
                const downBtn = document.createElement('button');
                downBtn.innerHTML = 'â†“';
                downBtn.title = 'ì•„ë˜ë¡œ';
                if (index === goal.images.length - 1) downBtn.disabled = true;
                downBtn.addEventListener('click', () => { moveImage(index, index + 1); });
                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = '&times;';
                deleteBtn.title = 'ì‚­ì œ';
                deleteBtn.addEventListener('click', () => { deleteImage(index); });
                controls.appendChild(upBtn);
                controls.appendChild(downBtn);
                controls.appendChild(deleteBtn);
                wrapper.appendChild(img);
                wrapper.appendChild(controls);
                goalProgressImages.appendChild(wrapper);
            });
        }
        function moveImage(index1, index2) {
            const goal = playgroundData.goals.find(g => g.id === selectedGoalId);
            if (!goal) return;
            [goal.images[index1], goal.images[index2]] = [goal.images[index2], goal.images[index1]];
            savePlaygroundData();
            renderGoalImages();
        }
        function deleteImage(index) {
            const goal = playgroundData.goals.find(g => g.id === selectedGoalId);
            if (!goal) return;
            goal.images.splice(index, 1);
            savePlaygroundData();
            renderGoalImages();
        }
        function cycleImageSize(index) {
            const goal = playgroundData.goals.find(g => g.id === selectedGoalId);
            if (!goal) return;
            const currentSize = goal.images[index].size;
            let newSize = '100';
            if (currentSize === '100') newSize = '75';
            else if (currentSize === '75') newSize = '50';
            else if (currentSize === '50') newSize = '100';
            goal.images[index].size = newSize;
            savePlaygroundData();
            renderGoalImages();
        }
        goalImageUpload.addEventListener('change', (event) => {
            if (!selectedGoalId) return;
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => { addImageToGoal(e.target.result); };
            reader.readAsDataURL(file);
            goalImageUpload.value = '';
        });
        exportGoalPdfBtn.addEventListener('click', () => {
            if (!selectedGoalId) { alert("PDFë¡œ ë‚´ë³´ë‚¼ ëª©í‘œë¥¼ ì„ íƒí•˜ì„¸ìš”."); return; }
            savePlaygroundData();
            const { jsPDF } = window.jspdf;
            const content = document.getElementById('goal-progress-content');
            const notesDiv = document.createElement('div');
            notesDiv.className = 'pdf-render-div';
            notesDiv.textContent = goalProgressNotes.value;
            goalProgressContent.insertBefore(notesDiv, goalProgressNotes);
            goalProgressNotes.classList.add('hidden');
            html2canvas(content, { scale: 2, useCORS: true }).then(canvas => {
                goalProgressContent.removeChild(notesDiv);
                goalProgressNotes.classList.remove('hidden');
                const imgData = canvas.toDataURL('image/png');
                const doc = new jsPDF('p', 'mm', 'a4');
                const imgProps = doc.getImageProperties(imgData);
                const pdfWidth = doc.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                let heightLeft = pdfHeight;
                let position = 0;
                const pageHeight = doc.internal.pageSize.getHeight();
                doc.addImage(imgData, 'PNG', 0, position, pdfWidth, pdfHeight);
                heightLeft -= pageHeight;
                while (heightLeft > 0) {
                    position = heightLeft - pdfHeight;
                    doc.addPage();
                    doc.addImage(imgData, 'PNG', 0, position, pdfWidth, pdfHeight);
                    heightLeft -= pageHeight;
                }
                const goal = playgroundData.goals.find(g => g.id === selectedGoalId);
                const fileName = goal ? `goal_${goal.text.substring(0, 20)}.pdf` : 'goal-progress.pdf';
                doc.save(fileName);
            });
        });

        function saveWeightData() {
            weightData.sort((a, b) => new Date(b.date) - new Date(a.date));
            localStorage.setItem(WEIGHT_KEY, JSON.stringify(weightData));
        }
        function loadWeightData() {
            const data = JSON.parse(localStorage.getItem(WEIGHT_KEY));
            if (data) { weightData = data; }
            renderWeightList();
            newWeightInput.placeholder = `${getDateKey(currentDate).replace(/-/g, '.')} ëª¸ë¬´ê²Œ (kg)`;
        }
        
        // --- â˜… ëª¸ë¬´ê²Œ ê¸°ë¡ ì‹œíŠ¸ íƒ€ì… ë Œë”ë§ í•¨ìˆ˜ ---
        function renderWeightList() {
            weightTableBody.innerHTML = '';
            weightData.forEach((entry, index) => {
                const tr = document.createElement('tr');
                
                // 1. ë‚ ì§œ ì…€ (ìˆ˜ì • ë¶ˆê°€)
                const tdDate = document.createElement('td');
                tdDate.className = 'date-cell';
                tdDate.textContent = entry.date.replace(/-/g, '.');
                tr.appendChild(tdDate);

                // 2. ëª¸ë¬´ê²Œ ì…€ (ì¸í’‹)
                const tdWeight = document.createElement('td');
                const inputWeight = document.createElement('input');
                inputWeight.type = 'number';
                inputWeight.step = '0.1';
                inputWeight.value = entry.weight;
                inputWeight.addEventListener('change', (e) => updateWeightData(entry.date, 'weight', e.target.value));
                inputWeight.addEventListener('blur', (e) => updateWeightData(entry.date, 'weight', e.target.value));
                inputWeight.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') inputWeight.blur();
                });
                tdWeight.appendChild(inputWeight);
                tr.appendChild(tdWeight);

                // 3. ìŒì£¼ëŸ‰ ì…€ (ì¸í’‹)
                const tdAlcohol = document.createElement('td');
                const inputAlcohol = document.createElement('input');
                inputAlcohol.type = 'text';
                inputAlcohol.value = entry.alcohol || '';
                inputAlcohol.addEventListener('change', (e) => updateWeightData(entry.date, 'alcohol', e.target.value));
                inputAlcohol.addEventListener('blur', (e) => updateWeightData(entry.date, 'alcohol', e.target.value));
                inputAlcohol.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') inputAlcohol.blur();
                });
                tdAlcohol.appendChild(inputAlcohol);
                tr.appendChild(tdAlcohol);

                // 4. ì‚­ì œ ë²„íŠ¼
                const tdDelete = document.createElement('td');
                const btnDelete = document.createElement('button');
                btnDelete.className = 'sheet-delete-btn';
                btnDelete.innerHTML = '&times;';
                btnDelete.title = 'ì‚­ì œ';
                btnDelete.addEventListener('click', () => deleteWeightEntry(entry.date));
                tdDelete.appendChild(btnDelete);
                tr.appendChild(tdDelete);

                weightTableBody.appendChild(tr);
            });
        }
        
        // --- â˜… ì‹œíŠ¸ ë°ì´í„° ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ---
        function updateWeightData(dateKey, field, value) {
            const entryIndex = weightData.findIndex(e => e.date === dateKey);
            if (entryIndex === -1) return;

            let newValue = value;
            if (field === 'weight') {
                newValue = parseFloat(value);
                if (!newValue || newValue <= 0) {
                     // ìœ íš¨í•˜ì§€ ì•Šì€ ê°’ì´ë©´ ì›ë˜ ê°’ìœ¼ë¡œ ë³µêµ¬ (ì„ íƒ ì‚¬í•­)
                     // ì—¬ê¸°ì„œëŠ” UI ì—…ë°ì´íŠ¸ê°€ ìë™ìœ¼ë¡œ ë˜ì§€ ì•Šìœ¼ë¯€ë¡œ renderWeightList í˜¸ì¶œ ì¶”ì²œ
                     return; 
                }
            } else if (field === 'alcohol') {
                newValue = value.trim();
            }

            weightData[entryIndex][field] = newValue;
            saveWeightData();
            // renderWeightList(); // í¬ì»¤ìŠ¤ ìƒìŒ ë°©ì§€ë¥¼ ìœ„í•´ ì „ì²´ ë¦¬ë Œë”ë§ì€ ìƒëµí•˜ê³  ë°ì´í„°ë§Œ ì €ì¥
        }

        function addNewWeight() {
            const weight = parseFloat(newWeightInput.value);
            if (!weight || weight <= 0) {
                alert("ì˜¬ë°”ë¥¸ ëª¸ë¬´ê²Œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
                return;
            }
            const alcohol = newAlcoholInput.value.trim();
            const dateKey = getDateKey(currentDate);
            const newEntry = { date: dateKey, weight: weight, alcohol: alcohol };
            const existingIndex = weightData.findIndex(e => e.date === dateKey);
            if (existingIndex > -1) {
                if(confirm(`ì´ë¯¸ ${dateKey} ë°ì´í„°ê°€ ìˆìŠµë‹ˆë‹¤. ë®ì–´ì“°ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    weightData[existingIndex] = newEntry;
                } else {
                    return;
                }
            } else {
                weightData.push(newEntry);
            }
            saveWeightData();
            renderWeightList();
            newWeightInput.value = '';
            newAlcoholInput.value = '';
            newWeightInput.placeholder = `${dateKey.replace(/-/g, '.')} ëª¸ë¬´ê²Œ (kg)`;
        }
        function deleteWeightEntry(dateKey) {
            if(!confirm("ì´ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            weightData = weightData.filter(e => e.date !== dateKey);
            saveWeightData();
            renderWeightList();
        }
        
        function handleWeightFileImport(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                const fileContent = event.target.result;
                const lines = fileContent.split('\n');
                let addedCount = 0;
                let updatedCount = 0;

                lines.forEach(line => {
                    const parts = line.trim().split(/\s+/);
                    if (parts.length < 2) return;

                    const dateStr = parts[0];
                    const weight = parseFloat(parts[1]);
                    const alcohol = parts.slice(2).join(' '); // ë‚˜ë¨¸ì§€ ë’·ë¶€ë¶„ì€ ìŒì£¼ëŸ‰

                    if (!weight || weight <= 0) return;

                    const dateParts = dateStr.split(/[.-]/);
                    if (dateParts.length !== 3) return;

                    const [year, month, day] = dateParts;
                    if (year.length !== 4 || month.length > 2 || day.length > 2) return;

                    const formattedDateKey = `${year.padStart(4, '20')}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                    
                    if (!/^\d{4}-\d{2}-\d{2}$/.test(formattedDateKey)) return;

                    const existingIndex = weightData.findIndex(e => e.date === formattedDateKey);
                    if (existingIndex > -1) {
                        weightData[existingIndex].weight = weight;
                        if (alcohol) weightData[existingIndex].alcohol = alcohol;
                        updatedCount++;
                    } else {
                        weightData.push({ date: formattedDateKey, weight: weight, alcohol: alcohol });
                        addedCount++;
                    }
                });

                saveWeightData();
                renderWeightList();
                alert(`ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ: ${addedCount}ê°œ ì¶”ê°€, ${updatedCount}ê°œ ì—…ë°ì´íŠ¸`);
                importWeightFile.value = '';
            };
            reader.readAsText(file);
        }

        function renderWeightChart() {
            if (currentChartInstance) {
                currentChartInstance.destroy();
            }
            const rangeLabels = ['1ê°œì›”', '3ê°œì›”', '6ê°œì›”', '1ë…„', '5ë…„', '10ë…„'];
            const rangeMonths = [1, 3, 6, 12, 60, 120];
            
            graphRangeLabel.textContent = rangeLabels[chartRangeMode];
            
            const cutoff = new Date();
            cutoff.setMonth(cutoff.getMonth() - rangeMonths[chartRangeMode]);
            cutoff.setHours(0, 0, 0, 0);

            const today = new Date();
            const labels = [];
            const dataPoints = [];
            const pointColors = [];
            const fullDateLabels = [];
            
            const weightMap = new Map();
            weightData.forEach(entry => {
                weightMap.set(entry.date, entry);
            });

            let currentDay = new Date(cutoff);
            while (currentDay <= today) {
                const dateKey = getDateKey(currentDay);
                
                // â˜… 2. ê·¸ë˜í”„ xì¶• ë¼ë²¨ ìˆ˜ì • (YYYY.MM.DD)
                const y = currentDay.getFullYear();
                const m = String(currentDay.getMonth() + 1).padStart(2, '0');
                const d = String(currentDay.getDate()).padStart(2, '0');
                labels.push(`${y}.${m}.${d}`);
                fullDateLabels.push(`${y}.${m}.${d}`);

                if (weightMap.has(dateKey)) {
                    const entry = weightMap.get(dateKey);
                    dataPoints.push(entry.weight);
                    // â˜… 2. ìŒì£¼ ì‹œ ë¹¨ê°„ìƒ‰, ì•„ë‹ˆë©´ íŒŒë€ìƒ‰
                    pointColors.push(entry.alcohol ? '#ff3b30' : '#007aff');
                } else {
                    dataPoints.push(null);
                    pointColors.push('#007aff');
                }
                
                currentDay.setDate(currentDay.getDate() + 1);
            }
            
            const ctx = weightChartCanvas.getContext('2d');
            currentChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ëª¸ë¬´ê²Œ (kg)',
                        data: dataPoints,
                        borderColor: '#007aff',
                        backgroundColor: 'rgba(0,122,255,0.1)',
                        fill: true,
                        tension: 0.1,
                        pointRadius: 4,
                        pointBackgroundColor: pointColors, // â˜… 2. ê°œë³„ ì  ìƒ‰ìƒ ì ìš©
                        spanGaps: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: false } },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    const dataIndex = context[0].dataIndex;
                                    return fullDateLabels[dataIndex];
                                },
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y} kg`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // --- ë‹¬ë ¥ ì´ˆê¸°í™” ---
        function initializeCalendar() {
            if (typeof flatpickr === 'undefined') {
                console.error("Flatpickr ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                return;
            }
            calendarInstance = flatpickr(calendarBtn, {
                locale: "ko",
                allowInput: false,
                dateFormat: "Y-m-d",
                onChange: function(selectedDates) {
                    if (selectedDates.length > 0) { changeDate(selectedDates[0]); }
                },
                onDayCreate: function(d, dStr, fp, dayElem) {
                    const dateKey = getDateKey(dayElem.dateObj);
                    if (localStorage.getItem(`plan_${dateKey}`)) {
                        dayElem.classList.add('day-has-data');
                    }
                },
            });
        }

        // --- ì•± ì´ˆê¸°í™” ---
        function initializeApp() {
            createTimeline();
            updateDateDisplay();
            initializeCalendar();
            loadPlanData();
            loadPlaygroundData();
            addGoalBtn.addEventListener('click', addNewGoal);
            newGoalInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addNewGoal();
            });
            loadWeightData();
            addWeightBtn.addEventListener('click', addNewWeight);
            newWeightInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addNewWeight();
            });
            
            importWeightFile.addEventListener('change', handleWeightFileImport);
            
            searchResultsModal.classList.add('hidden');
            settingsModal.classList.add('hidden');
            routineModal.classList.add('hidden');
        }

        initializeApp();

    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>